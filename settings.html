<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-100 to-gray-200 flex dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-gray-100">
  <aside class="w-64 bg-gray-900 text-white flex-shrink-0 flex flex-col min-h-screen sticky top-0">
    <div class="p-4 text-lg font-bold flex items-center"><a href="/" class="mr-2">ðŸ”­</a>Observatory Control Panel</div>
    <nav class="px-2 flex-1">
      <ul class="space-y-2">
        <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="http://10.0.179.242" target="_blank">AAGSolo</a></li>
        <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="http://data.smeird.com:3000/public-dashboards/9d4866d34e934549a20debd888358718?refresh=1m&from=now-24h&to=now&timezone=browser" target="_blank">Obs Graphs</a></li>
        <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="http://data.smeird.com:3000/public-dashboards/2ed28400ef714b6899a67ca635137a59" target="_blank">Weather</a></li>
        <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="http://ob.smeird.com" target="_blank">Public obs</a></li>
        <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="http://www.smeird.com" target="_blank">Public Weather</a></li>
        <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="https://clearoutside.com/forecast/51.81/-0.29" target="_blank">Night Forecast</a></li>
        <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="settings.html">Settings</a></li>
      </ul>
    </nav>
    <div class="p-4 flex items-center justify-between">
      <span class="text-sm">Dark Mode</span>
      <button id="darkModeToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600">
        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
      </button>
    </div>
  </aside>
  <main class="flex-1 p-6">
  <div class="bg-white dark:bg-gray-700 dark:text-gray-200 p-6 rounded shadow w-full max-w-4xl mx-auto">
    <h1 class="text-xl mb-4 text-gray-900 dark:text-gray-100">Configuration</h1>
    <form id="settingsForm" class="space-y-6">
      <section>
        <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">MQTT Server</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Host</label>
            <input name="MQTT_BROKER_URL" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium">Port</label>
            <input name="MQTT_PORT" type="number" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium">Username</label>
            <input name="MQTT_USERNAME" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium">Password</label>
            <input name="MQTT_PASSWORD" type="password" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
          </div>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">InfluxDB</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium">Host</label>
            <input name="INFLUX_HOST" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium">Org</label>
            <input name="INFLUX_ORG" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium">Bucket</label>
            <input name="INFLUX_BUCKET" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
          </div>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Sensors</h2>
        <div id="sensorsList" class="space-y-2"></div>
        <button type="button" id="addSensor" class="mt-2 bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-gray-100 px-2 py-1 rounded">Add Sensor</button>
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Roof</h2>
        <div class="space-y-2">
          <div class="flex space-x-2">
            <input id="roofOpenPath" class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 flex-1" placeholder="Open Path" />
            <input id="roofOpenLimit" class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 flex-1" placeholder="Roof Open Status Topic" />
          </div>
          <div class="flex space-x-2">
            <input id="roofClosePath" class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 flex-1" placeholder="Close Path" />
            <input id="roofCloseLimit" class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 flex-1" placeholder="Roof Closed Status Topic" />
          </div>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Switches</h2>
        <div id="switchesList" class="space-y-2"></div>
        <button type="button" id="addSwitch" class="mt-2 bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-gray-100 px-2 py-1 rounded">Add Switch</button>
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">SkyCam Topic</h2>
        <input name="MQTT_SKYCAM_TOPIC" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Dashboard Topics (comma separated)</h2>
        <input name="MQTT_DASHBOARD_TOPICS" class="mt-1 p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-full" />
      </section>

      <button type="submit" class="bg-blue-500 dark:bg-blue-600 text-white px-4 py-2 rounded">Save</button>
    </form>
    <div id="status" class="mt-4 text-sm"></div>
  </div>
  </main>
  <script type="module">
    import { loadConfig } from './js/mqttConfig.js';

    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
      const isDark = localStorage.getItem('theme') === 'dark';
      if (isDark) {
        document.documentElement.classList.add('dark');
        darkModeToggle.classList.remove('bg-gray-200');
        darkModeToggle.classList.add('bg-green-500');
        darkModeToggle.querySelector('span')?.classList.add('translate-x-5');
      }
      darkModeToggle.addEventListener('click', () => {
        const enabled = document.documentElement.classList.toggle('dark');
        darkModeToggle.classList.toggle('bg-green-500', enabled);
        darkModeToggle.classList.toggle('bg-gray-200', !enabled);
        darkModeToggle.querySelector('span')?.classList.toggle('translate-x-5');
        localStorage.setItem('theme', enabled ? 'dark' : 'light');
      });
    }

    const sensorsList = document.getElementById('sensorsList');
    const switchesList = document.getElementById('switchesList');

    function createSensorRow(data = {}) {
      const row = document.createElement('div');
      row.className = 'flex space-x-2 sensor-row';
      row.innerHTML = `
        <input class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 flex-1 sensor-path" placeholder="Path" value="${data.path || ''}">
        <input class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-24 sensor-unit" placeholder="Unit" value="${data.unit || ''}">
        <input class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 flex-1 sensor-name" placeholder="Name" value="${data.name || ''}">
        <input class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-24 sensor-green" type="number" step="any" placeholder="Green" value="${data.green || ''}">
        <select class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-28 sensor-direction">
          <option value="below" ${data.greenDirection === 'above' ? '' : 'selected'}>Below</option>
          <option value="above" ${data.greenDirection === 'above' ? 'selected' : ''}>Above</option>
        </select>
        <input class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-32 sensor-measurement" placeholder="Measurement" value="${data.influxMeasurement || ''}">
        <input class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 w-32 sensor-field" placeholder="Field" value="${data.influxField || ''}">
        <button type="button" class="remove bg-red-500 dark:bg-red-600 text-white px-2 rounded">X</button>`;
      row.querySelector('.remove').addEventListener('click', () => row.remove());
      sensorsList.appendChild(row);
    }

    function createSwitchRow(data = {}) {
      const row = document.createElement('div');
      row.className = 'flex space-x-2 switch-row';
      row.innerHTML = `
        <input class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 flex-1 switch-path" placeholder="Path" value="${data.path || ''}">
        <input class="p-2 border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 flex-1 switch-name" placeholder="Name" value="${data.name || ''}">
        <button type="button" class="remove bg-red-500 dark:bg-red-600 text-white px-2 rounded">X</button>`;
      row.querySelector('.remove').addEventListener('click', () => row.remove());
      switchesList.appendChild(row);
    }

    document.getElementById('addSensor').addEventListener('click', () => createSensorRow());
    document.getElementById('addSwitch').addEventListener('click', () => createSwitchRow());

    async function loadSettings() {
      const cfg = await loadConfig();
      document.querySelector('[name="MQTT_BROKER_URL"]').value = cfg.brokerUrl;
      document.querySelector('[name="MQTT_PORT"]').value = cfg.port;
      document.querySelector('[name="MQTT_USERNAME"]').value = cfg.username;
      document.querySelector('[name="MQTT_PASSWORD"]').value = cfg.password;
      document.querySelector('[name="MQTT_SKYCAM_TOPIC"]').value = cfg.skyCamTopic || '';
      document.querySelector('[name="MQTT_DASHBOARD_TOPICS"]').value = cfg.dashboardTopics.join(',');
      document.querySelector('[name="INFLUX_HOST"]').value = cfg.influxHost || '';
      document.querySelector('[name="INFLUX_ORG"]').value = cfg.influxOrg || '';
      document.querySelector('[name="INFLUX_BUCKET"]').value = cfg.influxBucket || '';
      cfg.sensors.forEach(s => createSensorRow(s));
      cfg.switches.forEach(s => createSwitchRow(s));
      document.getElementById('roofOpenPath').value = cfg.roof.open.path || '';
      document.getElementById('roofOpenLimit').value = cfg.roof.open.limit || '';
      document.getElementById('roofClosePath').value = cfg.roof.close.path || '';
      document.getElementById('roofCloseLimit').value = cfg.roof.close.limit || '';
    }
    loadSettings();

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        MQTT_BROKER_URL: document.querySelector('[name="MQTT_BROKER_URL"]').value,
        MQTT_PORT: document.querySelector('[name="MQTT_PORT"]').value,
        MQTT_USERNAME: document.querySelector('[name="MQTT_USERNAME"]').value,
        MQTT_PASSWORD: document.querySelector('[name="MQTT_PASSWORD"]').value,
        MQTT_SKYCAM_TOPIC: document.querySelector('[name="MQTT_SKYCAM_TOPIC"]').value,
        MQTT_DASHBOARD_TOPICS: document.querySelector('[name="MQTT_DASHBOARD_TOPICS"]').value,
        INFLUX_HOST: document.querySelector('[name="INFLUX_HOST"]').value,
        INFLUX_ORG: document.querySelector('[name="INFLUX_ORG"]').value,
        INFLUX_BUCKET: document.querySelector('[name="INFLUX_BUCKET"]').value,
        sensors: Array.from(document.querySelectorAll('.sensor-row')).map(r => ({
          path: r.querySelector('.sensor-path').value,
          unit: r.querySelector('.sensor-unit').value,
          name: r.querySelector('.sensor-name').value,
          green: r.querySelector('.sensor-green').value,
          greenDirection: r.querySelector('.sensor-direction').value,
          influxMeasurement: r.querySelector('.sensor-measurement').value,
          influxField: r.querySelector('.sensor-field').value
        })),
        switches: Array.from(document.querySelectorAll('.switch-row')).map(r => ({
          path: r.querySelector('.switch-path').value,
          name: r.querySelector('.switch-name').value
        })),
        roof: {
          open: {
            path: document.getElementById('roofOpenPath').value,
            limit: document.getElementById('roofOpenLimit').value
          },
          close: {
            path: document.getElementById('roofClosePath').value,
            limit: document.getElementById('roofCloseLimit').value
          }
        }
      };
      try {
        const res = await fetch('/save_config.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const body = await res.json();
        if (res.ok) {
          window.location.href = '/';
        } else {
          document.getElementById('status').textContent = body.error || 'Error';
        }
      } catch {
        document.getElementById('status').textContent = 'Error';
      }
    });
  </script>
</body>
</html>
