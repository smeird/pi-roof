<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Observatory</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script>
  const savedTheme = localStorage.getItem('theme') || 'system';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const enableDark = savedTheme === 'dark' || (savedTheme === 'system' && prefersDark);
  document.documentElement.classList.toggle('dark', enableDark);
</script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: {
          sans: ['"Plus Jakarta Sans"', 'ui-sans-serif', 'system-ui', 'sans-serif']
        },
        colors: {
          aurora: {
            200: '#c4d9ff',
            300: '#92b4ff',
            400: '#5b8fff',
            500: '#2d72ff'
          }
        }
      }
    }
  };
</script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="js/mqttClient.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<body class="min-h-screen font-sans antialiased text-slate-900 dark:text-slate-100">
<div class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
  <div class="absolute inset-0 bg-gradient-to-br from-slate-100 via-white to-slate-200 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950"></div>
  <div class="absolute left-1/2 top-[-10%] h-[520px] w-[520px] -translate-x-1/2 rounded-full bg-aurora-300/40 blur-3xl dark:bg-aurora-500/30"></div>
  <div class="absolute bottom-[-25%] right-[-10%] h-[480px] w-[480px] rounded-full bg-aurora-200/40 blur-3xl dark:bg-aurora-400/20"></div>
  <div class="absolute left-[-15%] top-1/3 h-72 w-72 rounded-full bg-white/40 blur-3xl dark:bg-white/5"></div>
</div>
<div id="overlay" class="fixed inset-0 z-30 bg-slate-900/60 backdrop-blur-sm hidden md:hidden"></div>
<div class="relative z-10 min-h-screen md:flex">
  <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 flex w-72 -translate-x-full transform flex-col border-r border-white/10 bg-slate-900/80 px-6 pb-6 pt-8 text-slate-100 backdrop-blur-lg transition-transform duration-300 md:relative md:translate-x-0 md:flex-shrink-0 md:border-r md:border-slate-200/20">
    <div class="mb-8 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3 text-lg font-semibold tracking-tight">
        <span class="grid h-10 w-10 place-items-center rounded-2xl bg-white/10 text-aurora-200 shadow ring-1 ring-white/20"><i class="fa-solid fa-binoculars"></i></span>
        <span class="leading-tight">Observatory</span>
      </a>
      <button id="closeSidebar" class="md:hidden text-slate-300 transition hover:text-white" aria-label="Close menu">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>
    <div class="space-y-6 overflow-y-auto">
      <div class="rounded-2xl border border-white/10 bg-white/10 p-4 shadow-inner backdrop-blur">
        <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-200/80">
          <span>Theme</span>
          <i class="fa-solid fa-circle-half-stroke text-aurora-200"></i>
        </div>
        <select id="themeSelect" class="mt-3 w-full rounded-xl border border-white/10 bg-slate-900/80 px-3 py-2 text-sm font-medium text-slate-100 shadow-sm outline-none transition focus:border-aurora-400 focus:ring-2 focus:ring-aurora-300/40">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="system">System</option>
        </select>
      </div>
      <nav class="space-y-2 text-sm font-medium">
        <p class="px-3 text-xs uppercase tracking-[0.3em] text-slate-200/60">Quick Links</p>
        <ul class="space-y-2">
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://10.0.179.242" target="_blank"><i class="fa-solid fa-mountain-sun text-aurora-200"></i><span>AAGSolo</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://data.smeird.com:3000/public-dashboards/9d4866d34e934549a20debd888358718?refresh=1m&amp;from=now-24h&amp;to=now&amp;timezone=browser" target="_blank"><i class="fa-solid fa-chart-line text-aurora-200"></i><span>Obs Graphs</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://data.smeird.com:3000/public-dashboards/2ed28400ef714b6899a67ca635137a59" target="_blank"><i class="fa-solid fa-cloud-sun text-aurora-200"></i><span>Weather</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://ob.smeird.com" target="_blank"><i class="fa-solid fa-earth-europe text-aurora-200"></i><span>Public obs</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://www.smeird.com" target="_blank"><i class="fa-solid fa-droplet text-aurora-200"></i><span>Public Weather</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="https://clearoutside.com/forecast/51.81/-0.29" target="_blank"><i class="fa-solid fa-moon-stars text-aurora-200"></i><span>Night Forecast</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="https://skycam.smeird.com" target="_blank"><i class="fa-solid fa-camera text-aurora-200"></i><span>SkyCam</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="settings.html"><i class="fa-solid fa-sliders text-aurora-200"></i><span>Settings</span></a></li>
        </ul>
      </nav>
    </div>
    <div class="mt-auto rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner backdrop-blur">
      <p class="text-xs uppercase tracking-[0.3em] text-slate-200/60">Connection</p>
      <div id="connectionStatus" class="mt-3 flex items-center text-sm text-slate-200/80">
        <span id="statusDot" class="mr-3 h-2.5 w-2.5 rounded-full bg-yellow-400 shadow-[0_0_0_4px_rgba(255,255,255,0.12)]"></span>
        <span id="statusText">Connecting...</span>
      </div>
    </div>
  </aside>

  <div class="flex min-h-screen flex-1 flex-col">

    <header class="flex items-center justify-between gap-4 bg-white/80 px-6 py-4 shadow-sm backdrop-blur dark:bg-slate-900/70 md:hidden">
      <div class="flex items-center gap-3 text-base font-semibold text-slate-700 dark:text-slate-100">
        <span class="grid h-9 w-9 place-items-center rounded-2xl bg-aurora-400/20 text-aurora-500 dark:bg-aurora-500/20"><i class="fa-solid fa-binoculars"></i></span>
        Observatory
      </div>
      <button id="menuButton" class="rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-slate-700 shadow-sm transition hover:-translate-y-0.5 hover:bg-white dark:border-white/10 dark:bg-slate-800/80 dark:text-slate-100" aria-label="Open menu">
        <i class="fa-solid fa-bars text-lg"></i>
      </button>
    </header>
    <main class="flex-1 px-4 py-10 sm:px-8">
      <div class="mx-auto flex w-full max-w-7xl flex-col gap-10">
        <div class="flex flex-col gap-3">
          <p class="text-sm uppercase tracking-[0.35em] text-slate-500/70 dark:text-slate-300/60">Live Control</p>
          <h1 class="text-4xl font-semibold tracking-tight text-slate-900 dark:text-white"><span class="bg-gradient-to-r from-aurora-400 via-blue-500 to-purple-500 bg-clip-text text-transparent">Dashboard</span></h1>
          <p class="max-w-3xl text-sm text-slate-600 dark:text-slate-300/80">Monitor sensor health, operate the roof and switches, and watch the skycam feed in a refreshed interface that keeps everything within easy reach.</p>
        </div>
        <section id="sensorCard" class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">Sensors</h2>
            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400"><span class="h-2.5 w-2.5 rounded-full bg-emerald-400"></span>Optimal</div>
          </div>
          <div id="sensorsContainer" class="mt-6 grid gap-4 sm:grid-cols-2 xl:grid-cols-3"></div>
        </section>
        <section id="roofCard" class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">Roof Controls</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300/80">Command roof motors and check limit sensors.</p>
          </div>
          <div id="roofBanner" class="mt-6 hidden items-center gap-3 rounded-2xl border border-rose-500/50 bg-rose-500/10 px-4 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-rose-600 shadow-sm dark:border-rose-400/60 dark:bg-rose-500/20 dark:text-rose-200">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span>Roof Moving</span>
          </div>
          <div class="mt-6 grid gap-4 xl:grid-cols-3">
            <div id="roofControls" class="grid gap-4 sm:grid-cols-2 xl:col-span-2"></div>
            <div id="roofStatus" class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 text-sm text-slate-700 shadow-sm dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-200"></div>
          </div>
        </section>
        <section class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">Switches</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300/80">Toggle observatory equipment with a single tap.</p>
          </div>
          <div id="switchesContainer" class="mt-6 grid gap-4 sm:grid-cols-2 xl:grid-cols-4"></div>
        </section>
        <section class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">Graphs</h2>
            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400"><span class="h-2 w-4 border-t-2 border-slate-400 border-dotted"></span>Dotted segments show values outside the green threshold.</div>
          </div>
          <div id="lineChart" class="mt-6 h-64 rounded-2xl bg-slate-900/5 dark:bg-black/30 md:h-96"></div>
        </section>
        <section id="skyCamCard" class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">SkyCam</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300/80">Live feed from the observatory sky camera.</p>
          </div>
          <div class="mt-6 overflow-hidden rounded-2xl border border-slate-200/60 dark:border-white/10">
            <img id="skyCamImage" class="h-auto w-full object-cover" alt="SkyCam" />
          </div>
        </section>
      </div>
    </main>
  </div>
</div>

<script type="module">
import { loadConfig } from './js/mqttConfig.js';

const menuButton = document.getElementById('menuButton');
const closeSidebar = document.getElementById('closeSidebar');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const themeSelect = document.getElementById('themeSelect');

function applyChartTheme(isDark) {
  Highcharts.setOptions({
    chart: {
      backgroundColor: 'transparent',
      plotBackgroundColor: 'transparent',
      plotBorderWidth: 0,
      style: { color: isDark ? '#f3f4f6' : '#0f172a' }
    },
    title: { style: { color: isDark ? '#f3f4f6' : '#0f172a' } },
    xAxis: {
      labels: { style: { color: isDark ? '#e2e8f0' : '#0f172a' } },
      gridLineColor: isDark ? '#1f2937' : '#e2e8f0',
      lineColor: isDark ? '#334155' : '#cbd5f5',
      tickColor: isDark ? '#334155' : '#94a3b8'
    },
    yAxis: {
      labels: { style: { color: isDark ? '#e2e8f0' : '#0f172a' } },
      title: { style: { color: isDark ? '#e2e8f0' : '#0f172a' } },
      gridLineColor: isDark ? '#1f2937' : '#e2e8f0',
      lineColor: isDark ? '#334155' : '#cbd5f5',
      tickColor: isDark ? '#334155' : '#94a3b8'
    },
    legend: { itemStyle: { color: isDark ? '#f3f4f6' : '#0f172a' } },
    tooltip: {
      backgroundColor: isDark ? '#111827' : '#ffffff',
      borderColor: isDark ? '#1d4ed8' : '#dbeafe',
      style: { color: isDark ? '#f3f4f6' : '#0f172a' }
    }
  });
}

function openMenu() {
  if (!sidebar || !overlay) return;
  sidebar.classList.remove('-translate-x-full');
  overlay.classList.remove('hidden');
  overlay.style.left = `${sidebar.offsetWidth}px`;
  document.body.classList.add('overflow-hidden');
}

function closeMenu() {
  if (!sidebar || !overlay) return;
  sidebar.classList.add('-translate-x-full');
  overlay.classList.add('hidden');
  overlay.style.left = '';
  document.body.classList.remove('overflow-hidden');
}

if (menuButton && sidebar && overlay) {
  const toggleSidebar = () => {
    if (sidebar.classList.contains('-translate-x-full')) {
      openMenu();
    } else {
      closeMenu();
    }
  };
  menuButton.addEventListener('click', toggleSidebar);
  overlay.addEventListener('click', toggleSidebar);
}

if (closeSidebar && overlay) {
  closeSidebar.addEventListener('click', closeMenu);
}

if (themeSelect) {
  const storedTheme = localStorage.getItem('theme') || 'system';
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

  function setTheme(theme) {
    const isDark = theme === 'dark' || (theme === 'system' && mediaQuery.matches);
    document.documentElement.classList.toggle('dark', isDark);
    applyChartTheme(isDark);
  }

  themeSelect.value = storedTheme;
  setTheme(storedTheme);

  themeSelect.addEventListener('change', e => {
    const value = e.target.value;
    localStorage.setItem('theme', value);
    setTheme(value);
    if (lineChart) {
      lineChart.destroy();
      initLineChart();
    }
  });

  mediaQuery.addEventListener('change', () => {
    if (localStorage.getItem('theme') === 'system') {
      setTheme('system');
      if (lineChart) {
        lineChart.destroy();
        initLineChart();
      }
    }
  });
} else {
  applyChartTheme(false);
}

let brokerUrl, port, username, password, dashboardTopics, sensors, skyCamTopic;
try {
  ({ brokerUrl, port, username, password, dashboardTopics, sensors, skyCamTopic } = await loadConfig());
} catch (err) {
  const statusEl = document.getElementById('statusText');
  if (statusEl) statusEl.textContent = 'Error connecting to MQTT';
  setControlsDisabled(true);
  console.error('MQTT init error:', err);
}

const roofEspBase = 'Observatory/roof-esp';
const roofEsp = {
  state: {
    openLimit: `${roofEspBase}/open_limit`,
    closeLimit: `${roofEspBase}/close_limit`,
    moving: `${roofEspBase}/moving`,
    enabled: `${roofEspBase}/enabled`,
    fault: `${roofEspBase}/fault`,
    faultCode: `${roofEspBase}/fault_code`,
    openMotor: `${roofEspBase}/state/open_motor`,
    closeMotor: `${roofEspBase}/state/close_motor`,
    relay3: `${roofEspBase}/state/relay3`,
    relay4: `${roofEspBase}/state/relay4`,
    relay5: `${roofEspBase}/state/relay5`,
    relay6: `${roofEspBase}/state/relay6`,
    relay7: `${roofEspBase}/state/relay7`,
    relay8: `${roofEspBase}/state/relay8`,
    heartbeat: `${roofEspBase}/heartbeat`
  },
  command: {
    open: `${roofEspBase}/command/open`,
    close: `${roofEspBase}/command/close`,
    stop: `${roofEspBase}/command/stop`,
    enabled: `${roofEspBase}/command/enabled`,
    faultClear: `${roofEspBase}/command/fault_clear`,
    beep: `${roofEspBase}/command/beep`,
    relay3: `${roofEspBase}/command/relay3`,
    relay4: `${roofEspBase}/command/relay4`,
    relay5: `${roofEspBase}/command/relay5`,
    relay6: `${roofEspBase}/command/relay6`,
    relay7: `${roofEspBase}/command/relay7`,
    relay8: `${roofEspBase}/command/relay8`
  },
  relayLabels: {
    relay3: '12V Power Supply (CH3)',
    relay4: 'White LED (CH4)',
    relay5: 'Red LED (CH5)',
    relay6: 'PC Power (CH6)',
    relay7: 'Dew Heater 12V Power (CH7)',
    relay8: 'Mount/Focus 12V Power (CH8)'
  }
};

const sensorValueEls = {};
const sensorIndicators = {};
const topics = new Set(dashboardTopics || []);
const skyCamCard = document.getElementById('skyCamCard');
const skyCamImage = document.getElementById('skyCamImage');
if (skyCamTopic) {
  topics.add(skyCamTopic);
  skyCamImage?.setAttribute('data-topic', skyCamTopic);
  skyCamImage?.setAttribute('data-static', '');
} else {
  skyCamCard?.classList.add('hidden');
}
const stateValues = {};
const commandStatusEls = {};
const stateStatusEls = {};
const statusValueEls = {};
const relayToggleButtons = [];
let lastHeartbeatAt = null;
const roofMotionButtons = {};
let mqttConnected = false;
let lineChart;
const lineSeries = {};
const sensorCard = document.getElementById('sensorCard');
const roofCard = document.getElementById('roofCard');
let roofClosed = false;

const sensorCardBaseBorderClasses = ['border-slate-200/60', 'dark:border-white/10'];
const sensorCardBaseBackgroundClasses = ['bg-white/80', 'dark:bg-slate-900/60'];
const sensorCardSafeBorderClasses = ['border-emerald-400/70', 'dark:border-emerald-400/50'];
const sensorCardSafeBackgroundClasses = [
  'bg-gradient-to-br',
  'from-emerald-200/80',
  'via-emerald-300/60',
  'to-emerald-400/80',
  'dark:from-emerald-600/40',
  'dark:via-emerald-500/30',
  'dark:to-emerald-400/30'
];

function setSensorCardState(isSafe) {
  if (!sensorCard) return;
  sensorCardSafeBorderClasses.forEach(cls => sensorCard.classList.toggle(cls, isSafe));
  sensorCardSafeBackgroundClasses.forEach(cls => sensorCard.classList.toggle(cls, isSafe));
  sensorCardBaseBorderClasses.forEach(cls => sensorCard.classList.toggle(cls, !isSafe));
  sensorCardBaseBackgroundClasses.forEach(cls => sensorCard.classList.toggle(cls, !isSafe));
}

setSensorCardState(false);

function updateRoofCardBorder() {
  if (!roofCard) return;
  if (roofClosed) {
    roofCard.classList.remove('border-rose-400/70');
  } else {
    roofCard.classList.add('border-rose-400/70');
  }
}

updateRoofCardBorder();

function addSensorCards() {
  const container = document.getElementById('sensorsContainer');
  sensors.forEach(s => {
    const card = document.createElement('div');
    card.className = 'group relative flex items-center justify-between gap-4 overflow-hidden rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:border-aurora-400/50 hover:shadow-xl dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';

    const left = document.createElement('span');
    left.className = 'flex items-center gap-3 text-sm font-medium';
    const indicator = document.createElement('span');
    indicator.className = 'h-3 w-3 rounded-full bg-rose-500 shadow-[0_0_0_3px_rgba(255,255,255,0.35)] dark:shadow-none';
    left.appendChild(indicator);
    const nameSpan = document.createElement('span');
    nameSpan.textContent = s.name;
    left.appendChild(nameSpan);
    if (s.influxMeasurement && s.influxField) {
      const icon = document.createElement('i');
      icon.className = 'fa-solid fa-chart-line text-aurora-400 transition group-hover:text-aurora-500';
      left.appendChild(icon);
      card.classList.add('cursor-pointer');
      card.addEventListener('click', () => {
        window.location.href = `history.html?sensor=${encodeURIComponent(s.path)}`;
      });
    }
    card.appendChild(left);

    const valueEl = document.createElement('span');
    valueEl.className = 'sensor-value font-mono text-base';
    valueEl.textContent = '--';
    valueEl.setAttribute('data-topic', s.path);
    valueEl.setAttribute('data-static', '');
    if (s.unit) valueEl.setAttribute('data-unit', s.unit);
    card.appendChild(valueEl);

    container.appendChild(card);
    sensorValueEls[s.path] = valueEl;
    sensorIndicators[s.path] = {
      el: indicator,
      green: parseFloat(s.green),
      direction: s.greenDirection || 'below',
      isGreen: false
    };
    topics.add(s.path);
  });
}

function createCommandStatusRow(commandTopic, stateTopic) {
  const statusRow = document.createElement('div');
  statusRow.className = 'mt-2 flex flex-wrap gap-3 text-xs text-slate-500 dark:text-slate-400';
  const commandStatus = document.createElement('span');
  commandStatus.textContent = 'Command: --';
  commandStatus.dataset.commandStatus = commandTopic;
  commandStatusEls[commandTopic] = commandStatus;
  statusRow.appendChild(commandStatus);
  if (stateTopic) {
    const stateStatus = document.createElement('span');
    stateStatus.textContent = 'State: waiting';
    stateStatus.dataset.stateStatus = stateTopic;
    stateStatus.dataset.topic = stateTopic;
    stateStatusEls[stateTopic] = stateStatus;
    statusRow.appendChild(stateStatus);
  }
  return statusRow;
}

function createActionCard({ label, description, commandTopic, stateTopic, icon }) {
  const card = document.createElement('div');
  card.className = 'rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-slate-800 shadow-sm transition dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between gap-4';
  const textWrap = document.createElement('div');
  textWrap.innerHTML = `<p class="text-sm font-medium">${label}</p>${description ? `<p class="text-xs text-slate-500 dark:text-slate-400">${description}</p>` : ''}`;
  const button = document.createElement('button');
  button.type = 'button';
  button.className = 'inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-700 shadow-sm transition hover:-translate-y-0.5 hover:border-aurora-400/60 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-50 dark:border-white/10 dark:bg-slate-800/70 dark:text-slate-200 dark:hover:text-white';
  button.dataset.commandTopic = commandTopic;
  button.innerHTML = `${icon ? `<i class="fa-solid ${icon}"></i>` : ''}<span>Send</span>`;
  header.appendChild(textWrap);
  header.appendChild(button);
  card.appendChild(header);
  card.appendChild(createCommandStatusRow(commandTopic, stateTopic));
  return { card, button };
}

function createToggleCard({ label, description, stateTopic, commandTopic }) {
  const card = document.createElement('div');
  card.className = 'rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-slate-800 shadow-sm transition dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between gap-4';
  const textWrap = document.createElement('div');
  textWrap.innerHTML = `<p class="text-sm font-medium">${label}</p>${description ? `<p class="text-xs text-slate-500 dark:text-slate-400">${description}</p>` : ''}`;
  const button = document.createElement('button');
  button.type = 'button';
  button.className = 'toggleButton relative inline-flex h-7 w-12 items-center rounded-full bg-slate-300 transition-colors duration-300 ease-out dark:bg-slate-700';
  button.dataset.topic = stateTopic;
  button.dataset.commandTopic = commandTopic;
  button.innerHTML = '<span class="inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition"></span>';
  header.appendChild(textWrap);
  header.appendChild(button);
  card.appendChild(header);
  card.appendChild(createCommandStatusRow(commandTopic, stateTopic));
  return { card, button };
}

function addRoofControls() {
  const container = document.getElementById('roofControls');
  if (!container) return;
  const openAction = createActionCard({
    label: 'Open Roof',
    description: 'Start opening the roof.',
    commandTopic: roofEsp.command.open,
    stateTopic: roofEsp.state.openMotor,
    icon: 'fa-arrow-up'
  });
  openAction.button.dataset.action = 'open';
  const closeAction = createActionCard({
    label: 'Close Roof',
    description: 'Start closing the roof.',
    commandTopic: roofEsp.command.close,
    stateTopic: roofEsp.state.closeMotor,
    icon: 'fa-arrow-down'
  });
  closeAction.button.dataset.action = 'close';
  const stopAction = createActionCard({
    label: 'Stop Motion',
    description: 'Halt roof movement.',
    commandTopic: roofEsp.command.stop,
    stateTopic: roofEsp.state.moving,
    icon: 'fa-ban'
  });
  stopAction.button.dataset.action = 'stop';
  const enabledToggle = createToggleCard({
    label: 'Motion Enabled',
    description: 'Master enable for roof movement.',
    stateTopic: roofEsp.state.enabled,
    commandTopic: roofEsp.command.enabled
  });
  const faultClearAction = createActionCard({
    label: 'Clear Fault',
    description: 'Reset latched faults.',
    commandTopic: roofEsp.command.faultClear,
    stateTopic: roofEsp.state.fault,
    icon: 'fa-triangle-exclamation'
  });
  const beepAction = createActionCard({
    label: 'Buzzer',
    description: 'Trigger the buzzer.',
    commandTopic: roofEsp.command.beep,
    stateTopic: roofEsp.state.heartbeat,
    icon: 'fa-bell'
  });

  [openAction, closeAction, stopAction, enabledToggle, faultClearAction, beepAction].forEach(item => {
    container.appendChild(item.card);
  });

  topics.add(roofEsp.state.openMotor);
  topics.add(roofEsp.state.closeMotor);
  topics.add(roofEsp.state.moving);
  topics.add(roofEsp.state.enabled);
  topics.add(roofEsp.state.fault);
  topics.add(roofEsp.state.heartbeat);

  roofMotionButtons.open = openAction.button;
  roofMotionButtons.close = closeAction.button;
  roofMotionButtons.stop = stopAction.button;
}

function addSwitchCards() {
  const container = document.getElementById('switchesContainer');
  if (!container) return;
  Object.entries(roofEsp.relayLabels).forEach(([relayKey, label]) => {
    const stateTopic = roofEsp.state[relayKey];
    const commandTopic = roofEsp.command[relayKey];
    const { card, button } = createToggleCard({
      label,
      description: 'Auxiliary relay output.',
      stateTopic,
      commandTopic
    });
    relayToggleButtons.push(button);
    container.appendChild(card);
    topics.add(stateTopic);
  });
}

function addRoofStatus() {
  const container = document.getElementById('roofStatus');
  if (!container) return;
  container.innerHTML = '';
  const items = [
    { label: 'Moving', topic: roofEsp.state.moving },
    { label: 'Open limit', topic: roofEsp.state.openLimit },
    { label: 'Close limit', topic: roofEsp.state.closeLimit },
    { label: 'Open motor', topic: roofEsp.state.openMotor },
    { label: 'Close motor', topic: roofEsp.state.closeMotor },
    { label: 'Fault', topic: roofEsp.state.fault },
    { label: 'Fault code', topic: roofEsp.state.faultCode },
    { label: 'Enabled', topic: roofEsp.state.enabled },
    { label: 'Heartbeat', topic: roofEsp.state.heartbeat }
  ];

  const list = document.createElement('div');
  list.className = 'space-y-2';
  items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between gap-3 rounded-xl border border-slate-200/60 bg-white/70 px-3 py-2 text-xs dark:border-white/10 dark:bg-slate-900/70';
    const label = document.createElement('span');
    label.className = 'font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400';
    label.textContent = item.label;
    const value = document.createElement('span');
    value.className = 'font-medium text-slate-700 dark:text-slate-100';
    value.textContent = 'Waiting...';
    value.dataset.topic = item.topic;
    statusValueEls[item.topic] = value;
    row.appendChild(label);
    row.appendChild(value);
    list.appendChild(row);
    topics.add(item.topic);
  });
  container.appendChild(list);
}

addSensorCards();
addRoofControls();
addSwitchCards();
addRoofStatus();
initLineChart();
setInterval(updateHeartbeatDisplay, 5000);

const topicElements = Array.from(document.querySelectorAll('[data-topic]'));
const staticTopics = new Set(
  topicElements.filter(el => el.hasAttribute('data-static')).map(el => el.getAttribute('data-topic'))
);

function setControlsDisabled(disabled) {
  document.querySelectorAll('.toggleButton').forEach(button => {
    button.disabled = disabled;
    button.classList.toggle('opacity-50', disabled);
    button.classList.toggle('cursor-not-allowed', disabled);
  });
  document.querySelectorAll('[data-command-topic]').forEach(button => {
    if (button.classList.contains('toggleButton')) return;
    button.disabled = disabled;
    button.classList.toggle('opacity-50', disabled);
    button.classList.toggle('cursor-not-allowed', disabled);
  });
}

function updateConnectionStatus(status, info) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  let color = 'bg-rose-500';
  let message = 'Disconnected';
  if (status === 'connected') {
    color = 'bg-emerald-400';
    message = 'Connected';
    setControlsDisabled(false);
    mqttConnected = true;
  } else if (status === 'reconnecting') {
    color = 'bg-amber-400';
    message = 'Reconnecting...';
    setControlsDisabled(true);
    mqttConnected = false;
  } else if (status === 'connecting') {
    color = 'bg-amber-400';
    message = 'Connecting...';
    setControlsDisabled(true);
    mqttConnected = false;
  } else if (status === 'error') {
    message = 'Error';
    if (info && info.message) message += ': ' + info.message;
    setControlsDisabled(true);
    mqttConnected = false;
  } else {
    setControlsDisabled(true);
    mqttConnected = false;
  }
  if (dot) dot.className = `mr-3 h-2.5 w-2.5 rounded-full shadow-[0_0_0_4px_rgba(255,255,255,0.12)] ${color}`;
  if (text) text.textContent = message;
  updateMotionButtons();
  updateRelayLockout();
}
setControlsDisabled(true);

function initLineChart() {
  const yAxis = sensors.map((s, idx) => ({
    title: { text: s.unit ? `${s.name} (${s.unit})` : s.name },
    opposite: idx % 2 === 1
  }));
  const series = sensors.map((s, idx) => {
    const green = parseFloat(s.green);
    let zones;
    if (!isNaN(green)) {
      zones = s.greenDirection === 'above'
        ? [{ value: green, dashStyle: 'Dot' }, {}]
        : [{ value: green }, { dashStyle: 'Dot' }];
    }
    return { name: s.name, data: [], yAxis: idx, zones, tooltip: { valueSuffix: s.unit ? ` ${s.unit}` : '' } };
  });
  lineChart = Highcharts.chart('lineChart', {
    chart: {
      type: 'line',
      backgroundColor: 'transparent',
      plotBackgroundColor: 'transparent',
      plotBorderWidth: 0
    },
    title: { text: null },
    xAxis: { type: 'datetime' },
    yAxis,
    series,
    credits: { enabled: false }
  });
  sensors.forEach((s, idx) => {
    lineSeries[s.path] = lineChart.series[idx];
  });
}

let mqttClient;
try {
  const url = new URL(brokerUrl);
  if (port) url.port = port;
  mqttClient = createClient({
    brokerUrl: url.toString(),
    options: { username, password }
  });
  mqttClient.on('status', updateConnectionStatus);
  mqttClient.on('error', err => console.error('MQTT client error:', err));

  mqttClient.on('connect', function() {
    topics.forEach(t => {
      mqttClient.subscribe(t);
      if (!staticTopics.has(t)) stateValues[t] = null;
    });
  });

  mqttClient.on('message', function(topic, message) {
    if (skyCamTopic && topic === skyCamTopic) {
      if (skyCamImage) {
        const blob = new Blob([message]);
        const url = URL.createObjectURL(blob);
        const prev = skyCamImage.dataset.url;
        if (prev) URL.revokeObjectURL(prev);
        skyCamImage.src = url;
        skyCamImage.dataset.url = url;
      }
      return;
    }
    const rawValue = message.toString();
    if (topic === roofEsp.state.heartbeat) {
      lastHeartbeatAt = new Date();
    }

    const num = parseFloat(rawValue);
    const rounded = !isNaN(num) ? Math.round(num * 10) / 10 : null;
    const displayValue = rounded !== null ? rounded.toString() : rawValue;
    if (sensorValueEls[topic]) {
      const el = sensorValueEls[topic];
      const unit = el.getAttribute('data-unit');
      el.textContent = unit ? displayValue + ' ' + unit : displayValue;
    }
    if (sensorIndicators[topic]) updateSensorIndicator(topic, displayValue);
    if (lineSeries[topic] && rounded !== null) {
      const series = lineSeries[topic];
      const shift = series.data.length > 50;
      series.addPoint([Date.now(), rounded], true, shift);
    }

    if (statusValueEls[topic]) updateStatusValue(topic, rawValue);
    if (stateStatusEls[topic]) updateStateStatus(topic, rawValue);

    if (!staticTopics.has(topic)) {
      stateValues[topic] = rawValue;
      updateToggleButton(topic, rawValue);
    }

    updateMotionButtons();
    updateRelayLockout();
    updateRoofBanner();
  });

  const sendCommand = (commandTopic, payload) => {
    if (!commandTopic) return;
    mqttClient.publish(commandTopic, payload, { qos: 1 });
    updateCommandStatus(commandTopic, payload);
  };

  document.querySelectorAll('.toggleButton').forEach(button => {
    button.addEventListener('click', function() {
      const stateTopic = this.getAttribute('data-topic');
      const commandTopic = this.getAttribute('data-command-topic');
      const currentState = stateValues[stateTopic];
      if (currentState !== '0' && currentState !== '1') return;
      const newState = currentState === '1' ? '0' : '1';
      sendCommand(commandTopic, newState);
    });
  });

  document.querySelectorAll('[data-command-topic]').forEach(button => {
    if (button.classList.contains('toggleButton')) return;
    button.addEventListener('click', function() {
      const commandTopic = this.getAttribute('data-command-topic');
      sendCommand(commandTopic, '1');
    });
  });
} catch (err) {
  const statusEl = document.getElementById('statusText');
  if (statusEl) statusEl.textContent = 'Error connecting to MQTT';
  setControlsDisabled(true);
  console.error('MQTT init error:', err);
}

function formatTimestamp(date) {
  return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function updateCommandStatus(commandTopic, payload) {
  const el = commandStatusEls[commandTopic];
  if (!el) return;
  el.textContent = `Command: ${payload} at ${formatTimestamp(new Date())}`;
}

function updateStateStatus(topic, value) {
  const el = stateStatusEls[topic];
  if (!el) return;
  el.textContent = `State: ${value} at ${formatTimestamp(new Date())}`;
}

function setStatusTone(el, tone) {
  const tones = [
    'text-emerald-600',
    'dark:text-emerald-200',
    'text-rose-600',
    'dark:text-rose-200',
    'text-amber-600',
    'dark:text-amber-200',
    'text-slate-700',
    'dark:text-slate-100'
  ];
  el.classList.remove(...tones);
  if (tone === 'good') {
    el.classList.add('text-emerald-600', 'dark:text-emerald-200');
  } else if (tone === 'bad') {
    el.classList.add('text-rose-600', 'dark:text-rose-200');
  } else if (tone === 'warn') {
    el.classList.add('text-amber-600', 'dark:text-amber-200');
  } else {
    el.classList.add('text-slate-700', 'dark:text-slate-100');
  }
}

function updateHeartbeatDisplay() {
  const el = statusValueEls[roofEsp.state.heartbeat];
  if (!el) return;
  if (!lastHeartbeatAt) {
    el.textContent = 'Waiting...';
    setStatusTone(el, 'warn');
    return;
  }
  const now = new Date();
  const diffMs = now - lastHeartbeatAt;
  if (diffMs > 90000) {
    el.textContent = 'Device offline';
    setStatusTone(el, 'bad');
  } else {
    el.textContent = `Last seen ${formatTimestamp(lastHeartbeatAt)}`;
    setStatusTone(el, 'good');
  }
}

function updateStatusValue(topic, value) {
  const el = statusValueEls[topic];
  if (!el) return;
  let text = value;
  let tone = 'neutral';
  if (topic === roofEsp.state.moving) {
    text = value === '1' ? 'Moving' : 'Stopped';
    tone = value === '1' ? 'warn' : 'good';
  } else if (topic === roofEsp.state.openLimit) {
    text = value === '1' ? 'Roof is open' : "Roof isn't open";
    tone = value === '1' ? 'good' : 'neutral';
    if (value === '1') roofClosed = false;
  } else if (topic === roofEsp.state.closeLimit) {
    text = value === '1' ? 'Roof is closed' : "Roof isn't closed";
    tone = value === '1' ? 'good' : 'neutral';
    roofClosed = value === '1';
  } else if (topic === roofEsp.state.openMotor) {
    text = value === '1' ? 'Open motor active' : 'Open motor idle';
    tone = value === '1' ? 'warn' : 'neutral';
  } else if (topic === roofEsp.state.closeMotor) {
    text = value === '1' ? 'Close motor active' : 'Close motor idle';
    tone = value === '1' ? 'warn' : 'neutral';
  } else if (topic === roofEsp.state.enabled) {
    text = value === '1' ? 'Enabled' : 'Disabled';
    tone = value === '1' ? 'good' : 'bad';
  } else if (topic === roofEsp.state.fault) {
    text = value === '1' ? 'Fault' : 'OK';
    tone = value === '1' ? 'bad' : 'good';
  } else if (topic === roofEsp.state.faultCode) {
    text = value;
  } else if (topic === roofEsp.state.heartbeat) {
    updateHeartbeatDisplay();
    updateRoofCardBorder();
    return;
  }
  el.textContent = text;
  setStatusTone(el, tone);
  updateRoofCardBorder();
}

function updateMotionButtons() {
  const enabled = stateValues[roofEsp.state.enabled];
  const fault = stateValues[roofEsp.state.fault];
  const openLimit = stateValues[roofEsp.state.openLimit];
  const closeLimit = stateValues[roofEsp.state.closeLimit];
  const baseAllowed = enabled === '1' && fault === '0';

  if (roofMotionButtons.open) {
    roofMotionButtons.open.disabled = !baseAllowed || openLimit !== '0';
  }
  if (roofMotionButtons.close) {
    roofMotionButtons.close.disabled = !baseAllowed || closeLimit !== '0';
  }
}

function updateRelayLockout() {
  if (!mqttConnected) return;
  const moving = stateValues[roofEsp.state.moving];
  relayToggleButtons.forEach(button => {
    if (!button) return;
    const shouldDisable = moving === '1';
    button.disabled = shouldDisable;
    button.classList.toggle('opacity-50', shouldDisable);
    button.classList.toggle('cursor-not-allowed', shouldDisable);
  });
}

function updateRoofBanner() {
  const banner = document.getElementById('roofBanner');
  if (!banner) return;
  const moving = stateValues[roofEsp.state.moving];
  banner.classList.toggle('hidden', moving !== '1');
  banner.classList.toggle('flex', moving === '1');
}

function updateSensorIndicator(topic, value) {
  const data = sensorIndicators[topic];
  if (!data) return;
  const num = parseFloat(value);
  if (!isNaN(num) && !isNaN(data.green)) {
    const isGreen = data.direction === 'above' ? num >= data.green : num <= data.green;
    data.isGreen = isGreen;
    if (isGreen) {
      data.el.classList.remove('bg-rose-500');
      data.el.classList.add('bg-emerald-400');
    } else {
      data.el.classList.remove('bg-emerald-400');
      data.el.classList.add('bg-rose-500');
    }
  } else {
    data.isGreen = false;
  }

  if (sensorCard) {
    const allGreen = Object.values(sensorIndicators).length > 0 &&
      Object.values(sensorIndicators).every(s => s.isGreen);
    setSensorCardState(allGreen);
  }
}

function updateToggleButton(topic, value) {
  const button = document.querySelector(`.toggleButton[data-topic='${topic}']`);
  if (button) {
    const knob = button.querySelector('span');
    if (value === '1') {
      button.classList.remove('bg-slate-300', 'dark:bg-slate-700');
      button.classList.add('bg-emerald-500');
      knob.classList.add('translate-x-5');
    } else {
      button.classList.remove('bg-emerald-500');
      button.classList.add('bg-slate-300', 'dark:bg-slate-700');
      knob.classList.remove('translate-x-5');
    }
  }
}
</script>
</body>
</html>
