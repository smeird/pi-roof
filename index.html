<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Observatory Control Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="js/mqttClient.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-100 to-gray-200 md:flex dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-gray-100">
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden"></div>
<aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-gray-900 text-white transform -translate-x-full md:translate-x-0 md:relative md:flex-shrink-0 flex flex-col transition-transform duration-200 z-40">
  <div class="p-4 text-lg font-bold flex items-center"><a href="/" class="mr-2">ðŸ”­</a>Observatory Control Panel</div>
  <nav class="px-2 flex-1">
    <ul class="space-y-2">
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="http://10.0.179.242" target="_blank">AAGSolo</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="http://data.smeird.com:3000/public-dashboards/9d4866d34e934549a20debd888358718?refresh=1m&from=now-24h&to=now&timezone=browser" target="_blank">Obs Graphs</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="http://data.smeird.com:3000/public-dashboards/2ed28400ef714b6899a67ca635137a59" target="_blank">Weather</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="http://ob.smeird.com" target="_blank">Public obs</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="http://www.smeird.com" target="_blank">Public Weather</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="https://clearoutside.com/forecast/51.81/-0.29" target="_blank">Night Forecast</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600" href="settings.html">Settings</a></li>
    </ul>
  </nav>
  <div class="p-4 flex items-center justify-between">
    <span class="text-sm">Dark Mode</span>
    <button id="darkModeToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600">
      <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
    </button>
  </div>
  <div id="connectionStatus" class="p-4 text-sm flex items-center text-gray-300 dark:text-gray-400">
    <span id="statusDot" class="h-2 w-2 rounded-full bg-yellow-500 mr-2"></span>
    <span id="statusText">Connecting...</span>
  </div>
</aside>
<div class="flex flex-col min-h-screen flex-1">
  <header class="md:hidden bg-gray-900 text-white p-4 flex items-center justify-between">
    <div class="text-lg font-bold flex items-center"><a href="/" class="mr-2">ðŸ”­</a>Observatory Control Panel</div>
    <button id="menuButton" class="focus:outline-none">
      <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
    </button>
  </header>
  <main class="flex-1 p-4 md:p-6 space-y-8">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Dashboard</h1>

  <!-- Sensors -->
  <section id="sensorCard" class="bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Sensors</h2>
    <div id="sensorsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Roof -->
  <section id="roofCard" class="bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Roof Controls</h2>
    <div id="roofControls" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
  </section>

  <!-- Switches -->
  <section class="bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Switches</h2>
    <div id="switchesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
  </section>

  <!-- Graphs -->
  <section class="bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Graphs</h2>
    <div id="lineChart" class="h-64 md:h-96"></div>
    <div class="flex items-center mt-2 text-xs text-gray-600 dark:text-gray-400">
      <span class="w-4 border-t-2 border-gray-400 border-dotted mr-2"></span>
      <span>Dotted segments indicate values outside the green threshold</span>
    </div>
  </section>

  <!-- SkyCam -->
  <section id="skyCamCard" class="bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">SkyCam</h2>
    <img id="skyCamImage" class="w-full h-auto rounded" alt="SkyCam" />
  </section>
</main>

</div>

<script type="module">
import { loadConfig } from './js/mqttConfig.js';

const menuButton = document.getElementById('menuButton');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const darkModeToggle = document.getElementById('darkModeToggle');
if (menuButton && sidebar && overlay) {
  const toggleSidebar = () => {
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
  };
  menuButton.addEventListener('click', toggleSidebar);
  overlay.addEventListener('click', toggleSidebar);
}

if (darkModeToggle) {
  const isDark = localStorage.getItem('theme') === 'dark';
  if (isDark) {
    document.documentElement.classList.add('dark');
    darkModeToggle.classList.remove('bg-gray-200');
    darkModeToggle.classList.add('bg-green-500');
    darkModeToggle.querySelector('span')?.classList.add('translate-x-5');
  }
  darkModeToggle.addEventListener('click', () => {
    const enabled = document.documentElement.classList.toggle('dark');
    darkModeToggle.classList.toggle('bg-green-500', enabled);
    darkModeToggle.classList.toggle('bg-gray-200', !enabled);
    darkModeToggle.querySelector('span')?.classList.toggle('translate-x-5');
    localStorage.setItem('theme', enabled ? 'dark' : 'light');
  });
}

let brokerUrl, port, username, password, dashboardTopics, sensors, switches, roof, skyCamTopic;
try {
  ({ brokerUrl, port, username, password, dashboardTopics, sensors, switches, roof, skyCamTopic } = await loadConfig());
} catch (err) {
  const statusEl = document.getElementById('statusText');
  if (statusEl) statusEl.textContent = 'Error connecting to MQTT';
  setToggleDisabled(true);
  console.error('MQTT init error:', err);
}

const sensorValueEls = {};
const sensorIndicators = {};
const indicatorEls = {};
const topics = new Set(dashboardTopics);
const skyCamCard = document.getElementById('skyCamCard');
const skyCamImage = document.getElementById('skyCamImage');
if (skyCamTopic) {
  topics.add(skyCamTopic);
  skyCamImage?.setAttribute('data-topic', skyCamTopic);
  skyCamImage?.setAttribute('data-static', '');
} else {
  skyCamCard?.classList.add('hidden');
}
const toggleStates = {};
let lineChart;
const lineSeries = {};
const sensorCard = document.getElementById('sensorCard');
const roofCard = document.getElementById('roofCard');
let roofClosed = false;

function updateRoofCardBorder() {
  if (!roofCard) return;
  if (roofClosed) {
    roofCard.classList.remove('border-2', 'border-red-500');
  } else {
    roofCard.classList.add('border-2', 'border-red-500');
  }
}

updateRoofCardBorder();

function addSensorCards() {
  const container = document.getElementById('sensorsContainer');
  sensors.forEach(s => {
    const card = document.createElement('div');
    card.className = 'p-4 bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow flex items-center justify-between';

    const left = document.createElement('span');
    left.className = 'flex items-center';
    const indicator = document.createElement('span');
    indicator.className = 'h-3 w-3 rounded-full bg-red-500 mr-2';
    left.appendChild(indicator);
    const nameSpan = document.createElement('span');
    nameSpan.textContent = s.name;
    left.appendChild(nameSpan);
    if (s.influxMeasurement && s.influxField) {
      const icon = document.createElement('span');
      icon.textContent = '\ud83d\udcc8';
      icon.className = 'ml-2';
      left.appendChild(icon);
      card.classList.add('cursor-pointer');
      card.addEventListener('click', () => {
        window.location.href = `history.html?sensor=${encodeURIComponent(s.path)}`;
      });
    }
    card.appendChild(left);

    const valueEl = document.createElement('span');
    valueEl.className = 'sensor-value font-mono';
    valueEl.textContent = '--';
    valueEl.setAttribute('data-topic', s.path);
    valueEl.setAttribute('data-static', '');
    if (s.unit) valueEl.setAttribute('data-unit', s.unit);
    card.appendChild(valueEl);

    container.appendChild(card);
    sensorValueEls[s.path] = valueEl;
    sensorIndicators[s.path] = {
      el: indicator,
      green: parseFloat(s.green),
      direction: s.greenDirection || 'below',
      isGreen: false
    };
    topics.add(s.path);
  });
}

function addRoofControls() {
  const container = document.getElementById('roofControls');
  if (roof.open.path) {
    const openDiv = document.createElement('div');
    openDiv.className = 'p-4 bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow flex items-center justify-between';
    openDiv.innerHTML = `<span>Open Roof</span><button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600" data-topic="${roof.open.path}"><span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span></button>`;
    container.appendChild(openDiv);
    topics.add(roof.open.path);
  }
  if (roof.close.path) {
    const closeDiv = document.createElement('div');
    closeDiv.className = 'p-4 bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow flex items-center justify-between';
    closeDiv.innerHTML = `<span>Close Roof</span><button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600" data-topic="${roof.close.path}"><span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span></button>`;
    container.appendChild(closeDiv);
    topics.add(roof.close.path);
  }
  if (roof.open.limit) {
    const openLimitDiv = document.createElement('div');
    openLimitDiv.className = 'p-4 bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow flex items-center';

    openLimitDiv.innerHTML = `<span class="mr-2" data-role="label">Roof isn't open</span><span class="h-3 w-3 rounded-full bg-gray-400" data-topic="${roof.open.limit}" data-static></span>`;

    container.appendChild(openLimitDiv);
    indicatorEls[roof.open.limit] = {
      indicator: openLimitDiv.querySelector('span[data-topic]'),
      label: openLimitDiv.querySelector('span[data-role="label"]'),
      type: 'open'
    };
    topics.add(roof.open.limit);
  }
  if (roof.close.limit) {
    const closeLimitDiv = document.createElement('div');
    closeLimitDiv.className = 'p-4 bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow flex items-center';

    closeLimitDiv.innerHTML = `<span class="mr-2" data-role="label">Roof isn't closed</span><span class="h-3 w-3 rounded-full bg-gray-400" data-topic="${roof.close.limit}" data-static></span>`;

    container.appendChild(closeLimitDiv);
    indicatorEls[roof.close.limit] = {
      indicator: closeLimitDiv.querySelector('span[data-topic]'),
      label: closeLimitDiv.querySelector('span[data-role="label"]'),
      type: 'close'
    };
    topics.add(roof.close.limit);
  }
}

function addSwitchCards() {
  const container = document.getElementById('switchesContainer');
  switches.forEach(sw => {
    const card = document.createElement('div');
    card.className = 'p-4 bg-white dark:bg-gray-700 dark:text-gray-200 rounded shadow flex items-center justify-between';
    card.innerHTML = `<span>${sw.name}</span><button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600" data-topic="${sw.path}"><span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span></button>`;
    container.appendChild(card);
    topics.add(sw.path);
  });
}

addSensorCards();
addRoofControls();
addSwitchCards();
initLineChart();

const topicElements = Array.from(document.querySelectorAll('[data-topic]'));
const staticTopics = new Set(
  topicElements.filter(el => el.hasAttribute('data-static')).map(el => el.getAttribute('data-topic'))
);

function setToggleDisabled(disabled) {
  document.querySelectorAll('.toggleButton').forEach(button => {
    button.disabled = disabled;
    button.classList.toggle('opacity-50', disabled);
    button.classList.toggle('cursor-not-allowed', disabled);
  });
}

function updateConnectionStatus(status, info) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  let color = 'bg-red-500';
  let message = 'Disconnected';
  if (status === 'connected') {
    color = 'bg-green-500';
    message = 'Connected';
    setToggleDisabled(false);
  } else if (status === 'reconnecting') {
    color = 'bg-yellow-500';
    message = 'Reconnecting...';
    setToggleDisabled(true);
  } else if (status === 'connecting') {
    color = 'bg-yellow-500';
    message = 'Connecting...';
    setToggleDisabled(true);
  } else if (status === 'error') {
    message = 'Error';
    if (info && info.message) message += ': ' + info.message;
    setToggleDisabled(true);
  } else {
    setToggleDisabled(true);
  }
  if (dot) dot.className = `h-2 w-2 rounded-full mr-2 ${color}`;
  if (text) text.textContent = message;
}
setToggleDisabled(true);

function initLineChart() {
  const yAxis = sensors.map((s, idx) => ({
    title: { text: s.name },
    opposite: idx % 2 === 1
  }));
  const series = sensors.map((s, idx) => {
    const green = parseFloat(s.green);
    let zones;
    if (!isNaN(green)) {
      zones = s.greenDirection === 'above'
        ? [{ value: green, dashStyle: 'Dot' }, {}]
        : [{ value: green }, { dashStyle: 'Dot' }];
    }
    return { name: s.name, data: [], yAxis: idx, zones };
  });
  lineChart = Highcharts.chart('lineChart', {
    chart: { type: 'line' },
    title: { text: null },
    xAxis: { type: 'datetime' },
    yAxis,
    series,
    credits: { enabled: false }
  });
  sensors.forEach((s, idx) => {
    lineSeries[s.path] = lineChart.series[idx];
  });
}

let mqttClient;
try {
  const url = new URL(brokerUrl);
  if (port) url.port = port;
  mqttClient = createClient({
    brokerUrl: url.toString(),
    options: { username, password }
  });
  mqttClient.on('status', updateConnectionStatus);
  mqttClient.on('error', err => console.error('MQTT client error:', err));

  mqttClient.on('connect', function() {
    topics.forEach(t => {
      mqttClient.subscribe(t);
      if (!staticTopics.has(t)) toggleStates[t] = '0';
    });
  });

  mqttClient.on('message', function(topic, message) {
    if (skyCamTopic && topic === skyCamTopic) {
      if (skyCamImage) {
        const blob = new Blob([message]);
        const url = URL.createObjectURL(blob);
        const prev = skyCamImage.dataset.url;
        if (prev) URL.revokeObjectURL(prev);
        skyCamImage.src = url;
        skyCamImage.dataset.url = url;
      }
      return;
    }
    const rawValue = message.toString();
    const num = parseFloat(rawValue);
    const rounded = !isNaN(num) ? Math.round(num * 10) / 10 : null;
    const displayValue = rounded !== null ? rounded.toString() : rawValue;
    if (sensorValueEls[topic]) {
      const el = sensorValueEls[topic];
      const unit = el.getAttribute('data-unit');
      el.textContent = unit ? displayValue + ' ' + unit : displayValue;
    }
    if (sensorIndicators[topic]) updateSensorIndicator(topic, displayValue);
    if (indicatorEls[topic]) updateIndicatorEl(indicatorEls[topic], rawValue);
    if (lineSeries[topic] && rounded !== null) {
      const series = lineSeries[topic];
      const shift = series.data.length > 50;
      series.addPoint([Date.now(), rounded], true, shift);
    }
    if (!staticTopics.has(topic)) {
      toggleStates[topic] = rawValue;
      updateToggleButton(topic, rawValue);
    }
  });

  document.querySelectorAll('.toggleButton').forEach(button => {
    button.addEventListener('click', function() {
      const topic = this.getAttribute('data-topic');
      const newState = toggleStates[topic] === '1' ? '0' : '1';
      mqttClient.publish(topic, newState, { qos: 2, retain: true });
    });
  });
} catch (err) {
  const statusEl = document.getElementById('statusText');
  if (statusEl) statusEl.textContent = 'Error connecting to MQTT';
  setToggleDisabled(true);
  console.error('MQTT init error:', err);
}

function updateIndicatorEl(data, value) {
  const el = data.indicator;
  el.classList.remove('bg-green-500','bg-red-500','bg-gray-400');
  el.classList.add(value === '1' ? 'bg-green-500' : 'bg-red-500');
  if (data.label) {
    if (data.type === 'open') {
      data.label.textContent = value === '1' ? 'Roof is open' : "Roof isn't open";
    } else if (data.type === 'close') {
      data.label.textContent = value === '1' ? 'Roof is closed' : "Roof isn't closed";
    }
  }
  if (data.type === 'open' && value === '1') {
    roofClosed = false;
  } else if (data.type === 'close') {
    roofClosed = value === '1';
  }
  updateRoofCardBorder();
}

function updateSensorIndicator(topic, value) {
  const data = sensorIndicators[topic];
  if (!data) return;
  const num = parseFloat(value);
  if (!isNaN(num) && !isNaN(data.green)) {
    const isGreen = data.direction === 'above' ? num >= data.green : num <= data.green;
    data.isGreen = isGreen;
    if (isGreen) {
      data.el.classList.remove('bg-red-500');
      data.el.classList.add('bg-green-500');
    } else {
      data.el.classList.remove('bg-green-500');
      data.el.classList.add('bg-red-500');
    }
  } else {
    data.isGreen = false;
  }

  if (sensorCard) {
    const allGreen = Object.values(sensorIndicators).length > 0 &&
      Object.values(sensorIndicators).every(s => s.isGreen);
    if (allGreen) {
      sensorCard.classList.add('border-2', 'border-green-500');
    } else {
      sensorCard.classList.remove('border-2', 'border-green-500');
    }
  }
}

function updateToggleButton(topic, value) {
  const button = document.querySelector(`.toggleButton[data-topic='${topic}']`);
  if (button) {
    const knob = button.querySelector('span');
    if (value === '1') {
      button.classList.remove('bg-gray-200');
      button.classList.add('bg-green-500');
      knob.classList.add('translate-x-5');
    } else {
      button.classList.remove('bg-green-500');
      button.classList.add('bg-gray-200');
      knob.classList.remove('translate-x-5');
    }
  }
}
</script>
</body>
</html>
