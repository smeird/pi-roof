<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Observatory Control Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="js/mqttClient.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
<script src="https://code.highcharts.com/modules/bullet.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-100 to-gray-200 flex">
<aside class="w-64 bg-gray-900 text-white flex-shrink-0 flex flex-col min-h-screen sticky top-0">
  <div class="p-4 text-lg font-bold">Observatory Control Panel</div>
  <nav class="px-2 flex-1">
    <ul class="space-y-2">
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="http://10.0.179.242" target="_blank">AAGSolo</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="http://data.smeird.com:3000/public-dashboards/9d4866d34e934549a20debd888358718?refresh=1m&from=now-24h&to=now&timezone=browser" target="_blank">Obs Graphs</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="http://data.smeird.com:3000/public-dashboards/2ed28400ef714b6899a67ca635137a59" target="_blank">Weather</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="http://ob.smeird.com" target="_blank">Public obs</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="http://www.smeird.com" target="_blank">Public Weather</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="https://clearoutside.com/forecast/51.81/-0.29" target="_blank">Night Forecast</a></li>
      <li><a class="block px-2 py-1 hover:bg-gray-700" href="settings.html">Settings</a></li>
    </ul>
  </nav>
</aside>
<main class="flex-1 p-6 space-y-8">
  <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
  <div id="connectionStatus" class="flex items-center text-sm text-gray-700">
    <span id="statusDot" class="h-2 w-2 rounded-full bg-yellow-500 mr-2"></span>
    <span id="statusText">Connecting...</span>
  </div>

  <!-- Sensor Data -->
  <section class="bg-white rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4">Sensor Data</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

      <div id="gauge-clouds" class="h-48" data-topic="Observatory/clouds" data-static></div>
      <div id="gauge-rain" class="h-48" data-topic="Observatory/rain" data-static></div>
      <div id="gauge-light" class="h-48" data-topic="Observatory/light" data-static></div>
      <div id="gauge-dew" class="h-48" data-topic="Observatory/dewp" data-static></div>
      <div id="gauge-sqm" class="h-48" data-topic="Observatory/sqm" data-static></div>
      <div id="gauge-stars" class="h-48" data-topic="skycam/stars" data-static></div>
    </div>
  </section>

  <!-- SkyCam -->
  <section class="bg-white rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4">SkyCam</h2>
    <a href="http://skycam.smeird.com" class="block">
      <img id="liveImage" src="https://skycam.smeird.com/indi-allsky/images/latest.jpg?cacheBuster=123456" alt="SkyCam Image" class="w-full h-auto rounded">
    </a>
  </section>

  <!-- Roof Controls -->
  <section class="bg-white rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4">Roof Controls</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Open Roof</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/roof/open">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Close Roof</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/roof/close">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center">
        <span class="mr-2">Open Limit</span>
        <span id="openLimitIndicator" class="h-3 w-3 rounded-full bg-gray-400" data-topic="Observatory/roof/openlimit"></span>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center">
        <span class="mr-2">Close Limit</span>
        <span id="closeLimitIndicator" class="h-3 w-3 rounded-full bg-gray-400" data-topic="Observatory/roof/closelimit"></span>
      </div>
    </div>
  </section>

  <!-- Observatory Switches -->
  <section class="bg-white rounded shadow p-6">
    <h2 class="text-xl font-semibold mb-4">Observatory Switches</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>12V Power</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/roof/power">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>White Lights</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/lights/white">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Red Lights</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/lights/red">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Desk Lights</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/lights/desk">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>PC</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/Scope/Computer">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Focus</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/Scope/Focus">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Dew</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/Scope/Dew">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Scope</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/Scope/Scope">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Patio Sensor</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/Hue/PatioSensor">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Veg Sensor</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="Observatory/Hue/ObservatorySensor">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
      <div class="p-4 bg-white rounded shadow flex items-center justify-between">
        <span>Workshop Motion</span>
        <button class="toggleButton relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200" data-topic="workshop/sensors/motion">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
        </button>
      </div>
    </div>
  </section>


</main>

<script type="module">
import { loadConfig } from './js/mqttConfig.js';

let brokerUrl, port, username, password;
let dashboardTopics = [];
let mqttClient;
try {
  ({ brokerUrl, port, username, password, dashboardTopics } = await loadConfig());
  mqttClient = createClient({
    brokerUrl: `${brokerUrl}:${port}`,
    options: {
      username,
      password
    }
  });
} catch (err) {
  const statusEl = document.getElementById('statusText');
  if (statusEl) statusEl.textContent = 'Error connecting to MQTT';
  setToggleDisabled(true);
  console.error('MQTT init error:', err);
}

// Highcharts gauge setup
function createGauge(id, title, min, max) {
  return Highcharts.chart(id, {
    chart: { type: 'solidgauge' },
    title: { text: title },
    pane: { center: ['50%', '85%'], size: '140%', startAngle: -90, endAngle: 90,
      background: { innerRadius: '60%', outerRadius: '100%', shape: 'arc' } },
    yAxis: { min: min, max: max, lineWidth: 0, tickAmount: 2,
      labels: { y: 16 }, stops: [[0.1, '#f87171'], [0.5, '#fbbf24'], [0.9, '#34d399']] },
    series: [{ data: [0], dataLabels: { format: '<span class="text-xl">{y}</span>' } }],
    tooltip: { enabled: false },
    credits: { enabled: false }
  });
}

function createBullet(id, title, min, max, target, color, neg) {
  return Highcharts.chart(id, {
    chart: { type: 'bullet', inverted: true },
    title: { text: title, align: 'left' },
    xAxis: { categories: [''], title: null },
    yAxis: { min: min, max: max, title: null, plotBands: [] },
    series: [{
      data: [{ y: 0, target: target }],
      threshold: target,
      color: color,
      negativeColor: neg
    }],
    tooltip: { enabled: false },
    credits: { enabled: false }
  });
}

const gaugeConfigs = {
  'Observatory/clouds': { id: 'gauge-clouds', title: 'Clouds', min: -40, max: 40 },
  'Observatory/rain': { id: 'gauge-rain', title: 'Rain', min: 0, max: 10000 },
  'Observatory/light': { id: 'gauge-light', title: 'Light', min: 0, max: 20000 },
  'Observatory/dewp': { id: 'gauge-dew', title: 'Dew', min: -10, max: 30 },
  'Observatory/sqm': { id: 'gauge-sqm', title: 'SQM', min: 0, max: 22 },
  'skycam/stars': { id: 'gauge-stars', title: 'Stars', min: 0, max: 50 }
};

const gaugeCharts = {};
Object.entries(gaugeConfigs).forEach(([topic, cfg]) => {
  gaugeCharts[topic] = createGauge(cfg.id, cfg.title, cfg.min, cfg.max);
});

const bulletConfigs = {
  'Observatory/Graph/clouds': { id: 'bullet-clouds', title: 'Clouds', min: -40, max: 40, target: -12, color: 'red', neg: 'green' },
  'Observatory/Graph/light': { id: 'bullet-light', title: 'Light', min: 0, max: 20000, target: 10000, color: 'green', neg: 'red' },
  'Observatory/Graph/rain': { id: 'bullet-rain', title: 'Rain', min: 0, max: 10000, target: 4200, color: 'green', neg: 'red' },
  'Observatory/Graph/hum': { id: 'bullet-hum', title: 'Humidity', min: 0, max: 100, target: 95, color: 'red', neg: 'green' },
  'Observatory/Graph/sqm': { id: 'bullet-sqm', title: 'Darkness', min: 0, max: 22, target: 15, color: 'green', neg: 'red' }
};

const bulletCharts = {};
Object.entries(bulletConfigs).forEach(([topic, cfg]) => {
  bulletCharts[topic] = createBullet(cfg.id, cfg.title, cfg.min, cfg.max, cfg.target, cfg.color, cfg.neg);
});

// MQTT handling
const toggleStates = {};

const topicElements = Array.from(document.querySelectorAll('[data-topic]'));
const topics = Array.from(new Set([
  ...topicElements.map(el => el.getAttribute('data-topic')),
  ...dashboardTopics
]));
const staticTopics = new Set(
  topicElements
    .filter(el => el.hasAttribute('data-static'))
    .map(el => el.getAttribute('data-topic'))
);


function setToggleDisabled(disabled) {
  document.querySelectorAll('.toggleButton').forEach(button => {
    button.disabled = disabled;
    button.classList.toggle('opacity-50', disabled);
    button.classList.toggle('cursor-not-allowed', disabled);
  });
}

function updateConnectionStatus(status, info) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  let color = 'bg-red-500';
  let message = 'Disconnected';
  if (status === 'connected') {
    color = 'bg-green-500';
    message = 'Connected';
    setToggleDisabled(false);
  } else if (status === 'reconnecting') {
    color = 'bg-yellow-500';
    message = 'Reconnecting...';
    setToggleDisabled(true);
  } else if (status === 'connecting') {
    color = 'bg-yellow-500';
    message = 'Connecting...';
    setToggleDisabled(true);
  } else if (status === 'error') {
    message = 'Error';
    if (info && info.message) message += ': ' + info.message;
    setToggleDisabled(true);
  } else {
    setToggleDisabled(true);
  }
  if (dot) dot.className = `h-2 w-2 rounded-full mr-2 ${color}`;
  if (text) text.textContent = message;
}
setToggleDisabled(true);

if (mqttClient) {
  mqttClient.on('status', updateConnectionStatus);
  mqttClient.on('error', err => console.error('MQTT client error:', err));

  mqttClient.on('connect', function() {
    topics.forEach(t => {
      mqttClient.subscribe(t);
      if (!staticTopics.has(t)) toggleStates[t] = '0';
    });
  });

  mqttClient.on('message', function(topic, message) {
    const value = message.toString();
    if (gaugeCharts[topic]) {
      const point = gaugeCharts[topic].series[0].points[0];
      point.update(parseFloat(value));
    }
    if (bulletCharts[topic]) {
      const chart = bulletCharts[topic];
      chart.series[0].points[0].update({ y: parseFloat(value) });
    }
    if (topic === 'Observatory/roof/openlimit') updateIndicator('openLimitIndicator', value);
    if (topic === 'Observatory/roof/closelimit') updateIndicator('closeLimitIndicator', value);
    if (!staticTopics.has(topic)) {
      toggleStates[topic] = value;
      updateToggleButton(topic, value);
    }
  });

  document.querySelectorAll('.toggleButton').forEach(button => {
    button.addEventListener('click', function() {
      const topic = this.getAttribute('data-topic');
      const newState = toggleStates[topic] === '1' ? '0' : '1';
      mqttClient.publish(topic, newState, { qos: 2, retain: true });
    });
  });
}

function updateIndicator(id, value) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('bg-green-500','bg-red-500','bg-gray-400');
  el.classList.add(value === '1' ? 'bg-green-500' : 'bg-red-500');
}

function updateToggleButton(topic, value) {
  const button = document.querySelector(`.toggleButton[data-topic='${topic}']`);
  if (button) {
    const knob = button.querySelector('span');
    if (value === '1') {
      button.classList.remove('bg-gray-200');
      button.classList.add('bg-green-500');
      knob.classList.add('translate-x-5');
    } else {
      button.classList.remove('bg-green-500');
      button.classList.add('bg-gray-200');
      knob.classList.remove('translate-x-5');
    }
  }
}
</script>

<script>
function refreshImage() {
  const image = document.getElementById('liveImage');
  const timestamp = new Date().getTime();
  image.src = 'http://skycam.local/current/tmp/image.jpg?' + timestamp;
}
setInterval(refreshImage, 120000);
</script>
</body>
</html>
