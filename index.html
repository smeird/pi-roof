<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Observatory</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ['"Plus Jakarta Sans"', 'ui-sans-serif', 'system-ui', 'sans-serif']
        },
        colors: {
          aurora: {
            200: '#c4d9ff',
            300: '#92b4ff',
            400: '#5b8fff',
            500: '#2d72ff'
          }
        }
      }
    }
  };
</script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="js/mqttClient.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<body class="min-h-screen font-sans antialiased text-slate-900 dark:text-slate-100">
<div class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
  <div class="absolute inset-0 bg-gradient-to-br from-slate-100 via-white to-slate-200 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950"></div>
  <div class="absolute left-1/2 top-[-10%] h-[520px] w-[520px] -translate-x-1/2 rounded-full bg-aurora-300/40 blur-3xl dark:bg-aurora-500/30"></div>
  <div class="absolute bottom-[-25%] right-[-10%] h-[480px] w-[480px] rounded-full bg-aurora-200/40 blur-3xl dark:bg-aurora-400/20"></div>
  <div class="absolute left-[-15%] top-1/3 h-72 w-72 rounded-full bg-white/40 blur-3xl dark:bg-white/5"></div>
</div>
<div id="overlay" class="fixed inset-0 z-30 bg-slate-900/60 backdrop-blur-sm hidden md:hidden"></div>
<div class="relative z-10 min-h-screen md:flex">
  <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 flex w-72 -translate-x-full transform flex-col border-r border-white/10 bg-slate-900/80 px-6 pb-6 pt-8 text-slate-100 backdrop-blur-lg transition-transform duration-300 md:relative md:translate-x-0 md:flex-shrink-0 md:border-r md:border-slate-200/20">
    <div class="mb-8 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3 text-lg font-semibold tracking-tight">
        <span class="grid h-10 w-10 place-items-center rounded-2xl bg-white/10 text-aurora-200 shadow ring-1 ring-white/20"><i class="fa-solid fa-binoculars"></i></span>
        <span class="leading-tight">Observatory</span>
      </a>
      <button id="closeSidebar" class="md:hidden text-slate-300 transition hover:text-white" aria-label="Close menu">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>
    <div class="space-y-6 overflow-y-auto">
      <div class="rounded-2xl border border-white/10 bg-white/10 p-4 shadow-inner backdrop-blur">
        <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-200/80">
          <span>Theme</span>
          <i class="fa-solid fa-circle-half-stroke text-aurora-200"></i>
        </div>
        <select id="themeSelect" class="mt-3 w-full rounded-xl border border-white/10 bg-slate-900/80 px-3 py-2 text-sm font-medium text-slate-100 shadow-sm outline-none transition focus:border-aurora-400 focus:ring-2 focus:ring-aurora-300/40">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="system">System</option>
        </select>
      </div>
      <nav class="space-y-2 text-sm font-medium">
        <p class="px-3 text-xs uppercase tracking-[0.3em] text-slate-200/60">Quick Links</p>
        <ul class="space-y-2">
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://10.0.179.242" target="_blank"><i class="fa-solid fa-mountain-sun text-aurora-200"></i><span>AAGSolo</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://data.smeird.com:3000/public-dashboards/9d4866d34e934549a20debd888358718?refresh=1m&amp;from=now-24h&amp;to=now&amp;timezone=browser" target="_blank"><i class="fa-solid fa-chart-line text-aurora-200"></i><span>Obs Graphs</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://data.smeird.com:3000/public-dashboards/2ed28400ef714b6899a67ca635137a59" target="_blank"><i class="fa-solid fa-cloud-sun text-aurora-200"></i><span>Weather</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://ob.smeird.com" target="_blank"><i class="fa-solid fa-earth-europe text-aurora-200"></i><span>Public obs</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="http://www.smeird.com" target="_blank"><i class="fa-solid fa-droplet text-aurora-200"></i><span>Public Weather</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="https://clearoutside.com/forecast/51.81/-0.29" target="_blank"><i class="fa-solid fa-moon-stars text-aurora-200"></i><span>Night Forecast</span></a></li>
          <li><a class="flex items-center gap-3 rounded-xl border border-transparent bg-white/5 px-3 py-2 text-slate-200 transition hover:-translate-y-0.5 hover:border-white/10 hover:bg-white/10 hover:text-white" href="settings.html"><i class="fa-solid fa-sliders text-aurora-200"></i><span>Settings</span></a></li>
        </ul>
      </nav>
    </div>
    <div class="mt-auto rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner backdrop-blur">
      <p class="text-xs uppercase tracking-[0.3em] text-slate-200/60">Connection</p>
      <div id="connectionStatus" class="mt-3 flex items-center text-sm text-slate-200/80">
        <span id="statusDot" class="mr-3 h-2.5 w-2.5 rounded-full bg-yellow-400 shadow-[0_0_0_4px_rgba(255,255,255,0.12)]"></span>
        <span id="statusText">Connecting...</span>
      </div>
    </div>
  </aside>

  <div class="flex min-h-screen flex-1 flex-col">

    <header class="flex items-center justify-between gap-4 bg-white/80 px-6 py-4 shadow-sm backdrop-blur dark:bg-slate-900/70 md:hidden">
      <div class="flex items-center gap-3 text-base font-semibold text-slate-700 dark:text-slate-100">
        <span class="grid h-9 w-9 place-items-center rounded-2xl bg-aurora-400/20 text-aurora-500 dark:bg-aurora-500/20"><i class="fa-solid fa-binoculars"></i></span>
        Observatory
      </div>
      <button id="menuButton" class="rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-slate-700 shadow-sm transition hover:-translate-y-0.5 hover:bg-white dark:border-white/10 dark:bg-slate-800/80 dark:text-slate-100" aria-label="Open menu">
        <i class="fa-solid fa-bars text-lg"></i>
      </button>
    </header>
    <main class="flex-1 px-4 py-10 sm:px-8">
      <div class="mx-auto flex w-full max-w-7xl flex-col gap-10">
        <div class="flex flex-col gap-3">
          <p class="text-sm uppercase tracking-[0.35em] text-slate-500/70 dark:text-slate-300/60">Live Control</p>
          <h1 class="text-4xl font-semibold tracking-tight text-slate-900 dark:text-white"><span class="bg-gradient-to-r from-aurora-400 via-blue-500 to-purple-500 bg-clip-text text-transparent">Dashboard</span></h1>
          <p class="max-w-3xl text-sm text-slate-600 dark:text-slate-300/80">Monitor sensor health, operate the roof and switches, and watch the skycam feed in a refreshed interface that keeps everything within easy reach.</p>
        </div>
        <section id="sensorCard" class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">Sensors</h2>
            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400"><span class="h-2.5 w-2.5 rounded-full bg-emerald-400"></span>Optimal</div>
          </div>
          <div id="sensorsContainer" class="mt-6 grid gap-4 sm:grid-cols-2 xl:grid-cols-3"></div>
        </section>
        <section id="roofCard" class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">Roof Controls</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300/80">Command roof motors and check limit sensors.</p>
          </div>
          <div id="roofControls" class="mt-6 grid gap-4 sm:grid-cols-2 xl:grid-cols-4"></div>
        </section>
        <section class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">Switches</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300/80">Toggle observatory equipment with a single tap.</p>
          </div>
          <div id="switchesContainer" class="mt-6 grid gap-4 sm:grid-cols-2 xl:grid-cols-4"></div>
        </section>
        <section class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">Graphs</h2>
            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400"><span class="h-2 w-4 border-t-2 border-slate-400 border-dotted"></span>Dotted segments show values outside the green threshold.</div>
          </div>
          <div id="lineChart" class="mt-6 h-64 rounded-2xl bg-slate-900/5 dark:bg-black/30 md:h-96"></div>
        </section>
        <section id="skyCamCard" class="rounded-3xl border border-slate-200/60 bg-white/80 p-6 shadow-xl backdrop-blur dark:border-white/10 dark:bg-slate-900/60">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">SkyCam</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300/80">Live feed from the observatory sky camera.</p>
          </div>
          <div class="mt-6 overflow-hidden rounded-2xl border border-slate-200/60 dark:border-white/10">
            <img id="skyCamImage" class="h-auto w-full object-cover" alt="SkyCam" />
          </div>
        </section>
      </div>
    </main>
  </div>
</div>

<script type="module">
import { loadConfig } from './js/mqttConfig.js';

const menuButton = document.getElementById('menuButton');
const closeSidebar = document.getElementById('closeSidebar');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const themeSelect = document.getElementById('themeSelect');

function applyChartTheme(isDark) {
  Highcharts.setOptions({
    chart: {
      backgroundColor: 'transparent',
      style: { color: isDark ? '#f3f4f6' : '#0f172a' }
    },
    title: { style: { color: isDark ? '#f3f4f6' : '#0f172a' } },
    xAxis: {
      labels: { style: { color: isDark ? '#e2e8f0' : '#0f172a' } },
      gridLineColor: isDark ? '#1f2937' : '#e2e8f0',
      lineColor: isDark ? '#334155' : '#cbd5f5',
      tickColor: isDark ? '#334155' : '#94a3b8'
    },
    yAxis: {
      labels: { style: { color: isDark ? '#e2e8f0' : '#0f172a' } },
      title: { style: { color: isDark ? '#e2e8f0' : '#0f172a' } },
      gridLineColor: isDark ? '#1f2937' : '#e2e8f0',
      lineColor: isDark ? '#334155' : '#cbd5f5',
      tickColor: isDark ? '#334155' : '#94a3b8'
    },
    legend: { itemStyle: { color: isDark ? '#f3f4f6' : '#0f172a' } },
    tooltip: {
      backgroundColor: isDark ? '#111827' : '#ffffff',
      borderColor: isDark ? '#1d4ed8' : '#dbeafe',
      style: { color: isDark ? '#f3f4f6' : '#0f172a' }
    }
  });
}

function closeMenu() {
  sidebar.classList.add('-translate-x-full');
  overlay.classList.add('hidden');
}

if (menuButton && sidebar && overlay) {
  const toggleSidebar = () => {
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
  };
  menuButton.addEventListener('click', toggleSidebar);
  overlay.addEventListener('click', toggleSidebar);
}

if (closeSidebar && overlay) {
  closeSidebar.addEventListener('click', closeMenu);
}

if (themeSelect) {
  const storedTheme = localStorage.getItem('theme') || 'system';
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

  function setTheme(theme) {
    const isDark = theme === 'dark' || (theme === 'system' && mediaQuery.matches);
    document.documentElement.classList.toggle('dark', isDark);
    applyChartTheme(isDark);
  }

  themeSelect.value = storedTheme;
  setTheme(storedTheme);

  themeSelect.addEventListener('change', e => {
    const value = e.target.value;
    localStorage.setItem('theme', value);
    setTheme(value);
    if (lineChart) {
      lineChart.destroy();
      initLineChart();
    }
  });

  mediaQuery.addEventListener('change', () => {
    if (localStorage.getItem('theme') === 'system') {
      setTheme('system');
      if (lineChart) {
        lineChart.destroy();
        initLineChart();
      }
    }
  });
} else {
  applyChartTheme(false);
}

let brokerUrl, port, username, password, dashboardTopics, sensors, switches, roof, skyCamTopic;
try {
  ({ brokerUrl, port, username, password, dashboardTopics, sensors, switches, roof, skyCamTopic } = await loadConfig());
} catch (err) {
  const statusEl = document.getElementById('statusText');
  if (statusEl) statusEl.textContent = 'Error connecting to MQTT';
  setToggleDisabled(true);
  console.error('MQTT init error:', err);
}

const sensorValueEls = {};
const sensorIndicators = {};
const indicatorEls = {};
const topics = new Set(dashboardTopics);
const skyCamCard = document.getElementById('skyCamCard');
const skyCamImage = document.getElementById('skyCamImage');
if (skyCamTopic) {
  topics.add(skyCamTopic);
  skyCamImage?.setAttribute('data-topic', skyCamTopic);
  skyCamImage?.setAttribute('data-static', '');
} else {
  skyCamCard?.classList.add('hidden');
}
const toggleStates = {};
let lineChart;
const lineSeries = {};
const sensorCard = document.getElementById('sensorCard');
const roofCard = document.getElementById('roofCard');
let roofClosed = false;

function updateRoofCardBorder() {
  if (!roofCard) return;
  if (roofClosed) {
    roofCard.classList.remove('border-rose-400/70');
  } else {
    roofCard.classList.add('border-rose-400/70');
  }
}

updateRoofCardBorder();

function addSensorCards() {
  const container = document.getElementById('sensorsContainer');
  sensors.forEach(s => {
    const card = document.createElement('div');
    card.className = 'group relative flex items-center justify-between gap-4 overflow-hidden rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:border-aurora-400/50 hover:shadow-xl dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';

    const left = document.createElement('span');
    left.className = 'flex items-center gap-3 text-sm font-medium';
    const indicator = document.createElement('span');
    indicator.className = 'h-3 w-3 rounded-full bg-rose-500 shadow-[0_0_0_3px_rgba(255,255,255,0.35)] dark:shadow-none';
    left.appendChild(indicator);
    const nameSpan = document.createElement('span');
    nameSpan.textContent = s.name;
    left.appendChild(nameSpan);
    if (s.influxMeasurement && s.influxField) {
      const icon = document.createElement('i');
      icon.className = 'fa-solid fa-chart-line text-aurora-400 transition group-hover:text-aurora-500';
      left.appendChild(icon);
      card.classList.add('cursor-pointer');
      card.addEventListener('click', () => {
        window.location.href = `history.html?sensor=${encodeURIComponent(s.path)}`;
      });
    }
    card.appendChild(left);

    const valueEl = document.createElement('span');
    valueEl.className = 'sensor-value font-mono text-base';
    valueEl.textContent = '--';
    valueEl.setAttribute('data-topic', s.path);
    valueEl.setAttribute('data-static', '');
    if (s.unit) valueEl.setAttribute('data-unit', s.unit);
    card.appendChild(valueEl);

    container.appendChild(card);
    sensorValueEls[s.path] = valueEl;
    sensorIndicators[s.path] = {
      el: indicator,
      green: parseFloat(s.green),
      direction: s.greenDirection || 'below',
      isGreen: false
    };
    topics.add(s.path);
  });
}

function addRoofControls() {
  const container = document.getElementById('roofControls');
  if (roof.open.path) {
    const openDiv = document.createElement('div');
    openDiv.className = 'flex items-center justify-between gap-4 rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-slate-800 shadow-sm dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';
    openDiv.innerHTML = `<span class="text-sm font-medium">Open Roof</span><button class="toggleButton relative inline-flex h-7 w-12 items-center rounded-full bg-slate-300 transition-colors duration-300 ease-out dark:bg-slate-700" data-topic="${roof.open.path}"><span class="inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition"></span></button>`;
    container.appendChild(openDiv);
    topics.add(roof.open.path);
  }
  if (roof.close.path) {
    const closeDiv = document.createElement('div');
    closeDiv.className = 'flex items-center justify-between gap-4 rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-slate-800 shadow-sm dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';
    closeDiv.innerHTML = `<span class="text-sm font-medium">Close Roof</span><button class="toggleButton relative inline-flex h-7 w-12 items-center rounded-full bg-slate-300 transition-colors duration-300 ease-out dark:bg-slate-700" data-topic="${roof.close.path}"><span class="inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition"></span></button>`;
    container.appendChild(closeDiv);
    topics.add(roof.close.path);
  }
  if (roof.open.limit) {
    const openLimitDiv = document.createElement('div');
    openLimitDiv.className = 'flex items-center gap-3 rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-sm text-slate-800 shadow-sm dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';

    openLimitDiv.innerHTML = `<span class="font-medium" data-role="label">Roof isn't open</span><span class="h-3 w-3 rounded-full bg-slate-400" data-topic="${roof.open.limit}" data-static></span>`;

    container.appendChild(openLimitDiv);
    indicatorEls[roof.open.limit] = {
      indicator: openLimitDiv.querySelector('span[data-topic]'),
      label: openLimitDiv.querySelector('span[data-role="label"]'),
      type: 'open'
    };
    topics.add(roof.open.limit);
  }
  if (roof.close.limit) {
    const closeLimitDiv = document.createElement('div');
    closeLimitDiv.className = 'flex items-center gap-3 rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-sm text-slate-800 shadow-sm dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';

    closeLimitDiv.innerHTML = `<span class="font-medium" data-role="label">Roof isn't closed</span><span class="h-3 w-3 rounded-full bg-slate-400" data-topic="${roof.close.limit}" data-static></span>`;

    container.appendChild(closeLimitDiv);
    indicatorEls[roof.close.limit] = {
      indicator: closeLimitDiv.querySelector('span[data-topic]'),
      label: closeLimitDiv.querySelector('span[data-role="label"]'),
      type: 'close'
    };
    topics.add(roof.close.limit);
  }
}

function addSwitchCards() {
  const container = document.getElementById('switchesContainer');
  switches.forEach(sw => {
    const card = document.createElement('div');
    card.className = 'flex items-center justify-between gap-4 rounded-2xl border border-slate-200/60 bg-white/70 px-4 py-3 text-slate-800 shadow-sm dark:border-white/10 dark:bg-slate-900/60 dark:text-slate-100';
    card.innerHTML = `<span class="text-sm font-medium">${sw.name}</span><button class="toggleButton relative inline-flex h-7 w-12 items-center rounded-full bg-slate-300 transition-colors duration-300 ease-out dark:bg-slate-700" data-topic="${sw.path}"><span class="inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition"></span></button>`;
    container.appendChild(card);
    topics.add(sw.path);
  });
}

addSensorCards();
addRoofControls();
addSwitchCards();
initLineChart();

const topicElements = Array.from(document.querySelectorAll('[data-topic]'));
const staticTopics = new Set(
  topicElements.filter(el => el.hasAttribute('data-static')).map(el => el.getAttribute('data-topic'))
);

function setToggleDisabled(disabled) {
  document.querySelectorAll('.toggleButton').forEach(button => {
    button.disabled = disabled;
    button.classList.toggle('opacity-50', disabled);
    button.classList.toggle('cursor-not-allowed', disabled);
  });
}

function updateConnectionStatus(status, info) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  let color = 'bg-rose-500';
  let message = 'Disconnected';
  if (status === 'connected') {
    color = 'bg-emerald-400';
    message = 'Connected';
    setToggleDisabled(false);
  } else if (status === 'reconnecting') {
    color = 'bg-amber-400';
    message = 'Reconnecting...';
    setToggleDisabled(true);
  } else if (status === 'connecting') {
    color = 'bg-amber-400';
    message = 'Connecting...';
    setToggleDisabled(true);
  } else if (status === 'error') {
    message = 'Error';
    if (info && info.message) message += ': ' + info.message;
    setToggleDisabled(true);
  } else {
    setToggleDisabled(true);
  }
  if (dot) dot.className = `mr-3 h-2.5 w-2.5 rounded-full shadow-[0_0_0_4px_rgba(255,255,255,0.12)] ${color}`;
  if (text) text.textContent = message;
}
setToggleDisabled(true);

function initLineChart() {
  const yAxis = sensors.map((s, idx) => ({
    title: { text: s.unit ? `${s.name} (${s.unit})` : s.name },
    opposite: idx % 2 === 1
  }));
  const series = sensors.map((s, idx) => {
    const green = parseFloat(s.green);
    let zones;
    if (!isNaN(green)) {
      zones = s.greenDirection === 'above'
        ? [{ value: green, dashStyle: 'Dot' }, {}]
        : [{ value: green }, { dashStyle: 'Dot' }];
    }
    return { name: s.name, data: [], yAxis: idx, zones, tooltip: { valueSuffix: s.unit ? ` ${s.unit}` : '' } };
  });
  lineChart = Highcharts.chart('lineChart', {
    chart: { type: 'line' },
    title: { text: null },
    xAxis: { type: 'datetime' },
    yAxis,
    series,
    credits: { enabled: false }
  });
  sensors.forEach((s, idx) => {
    lineSeries[s.path] = lineChart.series[idx];
  });
}

let mqttClient;
try {
  const url = new URL(brokerUrl);
  if (port) url.port = port;
  mqttClient = createClient({
    brokerUrl: url.toString(),
    options: { username, password }
  });
  mqttClient.on('status', updateConnectionStatus);
  mqttClient.on('error', err => console.error('MQTT client error:', err));

  mqttClient.on('connect', function() {
    topics.forEach(t => {
      mqttClient.subscribe(t);
      if (!staticTopics.has(t)) toggleStates[t] = '0';
    });
  });

  mqttClient.on('message', function(topic, message) {
    if (skyCamTopic && topic === skyCamTopic) {
      if (skyCamImage) {
        const blob = new Blob([message]);
        const url = URL.createObjectURL(blob);
        const prev = skyCamImage.dataset.url;
        if (prev) URL.revokeObjectURL(prev);
        skyCamImage.src = url;
        skyCamImage.dataset.url = url;
      }
      return;
    }
    const rawValue = message.toString();
    const num = parseFloat(rawValue);
    const rounded = !isNaN(num) ? Math.round(num * 10) / 10 : null;
    const displayValue = rounded !== null ? rounded.toString() : rawValue;
    if (sensorValueEls[topic]) {
      const el = sensorValueEls[topic];
      const unit = el.getAttribute('data-unit');
      el.textContent = unit ? displayValue + ' ' + unit : displayValue;
    }
    if (sensorIndicators[topic]) updateSensorIndicator(topic, displayValue);
    if (indicatorEls[topic]) updateIndicatorEl(indicatorEls[topic], rawValue);
    if (lineSeries[topic] && rounded !== null) {
      const series = lineSeries[topic];
      const shift = series.data.length > 50;
      series.addPoint([Date.now(), rounded], true, shift);
    }
    if (!staticTopics.has(topic)) {
      toggleStates[topic] = rawValue;
      updateToggleButton(topic, rawValue);
    }
  });

  document.querySelectorAll('.toggleButton').forEach(button => {
    button.addEventListener('click', function() {
      const topic = this.getAttribute('data-topic');
      const newState = toggleStates[topic] === '1' ? '0' : '1';
      mqttClient.publish(topic, newState, { qos: 2, retain: true });
    });
  });
} catch (err) {
  const statusEl = document.getElementById('statusText');
  if (statusEl) statusEl.textContent = 'Error connecting to MQTT';
  setToggleDisabled(true);
  console.error('MQTT init error:', err);
}

function updateIndicatorEl(data, value) {
  const el = data.indicator;
  el.classList.remove('bg-emerald-400','bg-rose-500','bg-slate-400');
  el.classList.add(value === '1' ? 'bg-emerald-400' : 'bg-rose-500');
  if (data.label) {
    if (data.type === 'open') {
      data.label.textContent = value === '1' ? 'Roof is open' : "Roof isn't open";
    } else if (data.type === 'close') {
      data.label.textContent = value === '1' ? 'Roof is closed' : "Roof isn't closed";
    }
  }
  if (data.type === 'open' && value === '1') {
    roofClosed = false;
  } else if (data.type === 'close') {
    roofClosed = value === '1';
  }
  updateRoofCardBorder();
}

function updateSensorIndicator(topic, value) {
  const data = sensorIndicators[topic];
  if (!data) return;
  const num = parseFloat(value);
  if (!isNaN(num) && !isNaN(data.green)) {
    const isGreen = data.direction === 'above' ? num >= data.green : num <= data.green;
    data.isGreen = isGreen;
    if (isGreen) {
      data.el.classList.remove('bg-rose-500');
      data.el.classList.add('bg-emerald-400');
    } else {
      data.el.classList.remove('bg-emerald-400');
      data.el.classList.add('bg-rose-500');
    }
  } else {
    data.isGreen = false;
  }

  if (sensorCard) {
    const allGreen = Object.values(sensorIndicators).length > 0 &&
      Object.values(sensorIndicators).every(s => s.isGreen);
    if (allGreen) {
      sensorCard.classList.add('border-emerald-400/70');
    } else {
      sensorCard.classList.remove('border-emerald-400/70');
    }
  }
}

function updateToggleButton(topic, value) {
  const button = document.querySelector(`.toggleButton[data-topic='${topic}']`);
  if (button) {
    const knob = button.querySelector('span');
    if (value === '1') {
      button.classList.remove('bg-slate-300', 'dark:bg-slate-700');
      button.classList.add('bg-emerald-500');
      knob.classList.add('translate-x-5');
    } else {
      button.classList.remove('bg-emerald-500');
      button.classList.add('bg-slate-300', 'dark:bg-slate-700');
      knob.classList.remove('translate-x-5');
    }
  }
}
</script>
</body>
</html>
