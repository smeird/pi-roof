<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observatory Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>



  <!-- Bootstrap Navbar for Title Bar -->
    <nav class="bg-gray-800">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a class="text-white font-bold" href="#">Observatory Control Panel</a>
                <ul class="flex space-x-4">
                    <li><a class="text-gray-300 hover:text-white" href="http://10.0.179.242" target="_blank">AAGSolo</a></li>
                    <li><a class="text-gray-300 hover:text-white" href="http://data.smeird.com:3000/public-dashboards/9d4866d34e934549a20debd888358718?refresh=1m&from=now-24h&to=now&timezone=browser" target="_blank">Obs Graphs</a></li>
                    <li><a class="text-gray-300 hover:text-white" href="http://data.smeird.com:3000/public-dashboards/2ed28400ef714b6899a67ca635137a59" target="_blank">Weather</a></li>
                    <li><a class="text-gray-300 hover:text-white" href="http://ob.smeird.com" target="_blank">Public obs</a></li>
                    <li><a class="text-gray-300 hover:text-white" href="http://www.smeird.com" target="_blank">Public Weather</a></li>
                    <li><a class="text-gray-300 hover:text-white" href="https://clearoutside.com/forecast/51.81/-0.29" target="_blank">Night Forcast</a></li>
                </ul>
            </div>
        </div>
    </nav>





<div class="container mx-auto mt-5">

<!-- New Rows for Additional Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
    <!-- Example Card (Repeat for each new topic) -->
    <div>
        <div id="cloudsCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Clouds</div>
            <div class="card-body p-4">
                <p class="card-text" id="cloudsStatus" data-topic="Observatory/clouds">Loading...</p>
            </div>
        </div>
    </div>
    <div>
        <div id="rainCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Rain</div>
            <div class="card-body p-4">
                <p class="card-text" id="rainStatus" data-topic="Observatory/rain">Loading...</p>
            </div>
        </div>
    </div>
    <div>
        <div id="lightCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Light</div>
            <div class="card-body p-4">
                <p class="card-text" id="lightStatus" data-topic="Observatory/light">Loading...</p>
            </div>
        </div>
    </div>
    <div>
        <div id="dewCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Dew</div>
            <div class="card-body p-4">
                <p class="card-text" id="dewStatus" data-topic="Observatory/dewp">Loading...</p>
            </div>
        </div>
    </div>
  <div>
        <div id="sqmCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">SQM</div>
            <div class="card-body p-4">
                <p class="card-text" id="sqmStatus" data-topic="Observatory/sqm">Loading...</p>
            </div>
        </div>
    </div>

 <div>
        <div id="starsCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Stars</div>
            <div class="card-body p-4">
                <p class="card-text" id="starsStatus" data-topic="skycam/stars">Loading...</p>
            </div>
        </div>
    </div>








    <!-- Repeat for other 7 cards in the row -->
</div>
<!-- Repeat for the second row with different topics -->

<hr>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
              <!-- White Lights Card -->
            <div>
                <div id="whiteLightsCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">12V Power</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/roof/power">Toggle</button>
                    
                </div>
            </div>          
                
            <!-- White Lights Card -->
            <div>
                <div id="whiteLightsCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    
                    <div class="card-header px-4 py-2 font-semibold border-b">White Lights</div>
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/lights/white">Toggle</button>
                    
                </div>
            </div>

            <!-- Red Lights Card -->
            <div>
                <div id="redLightsCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Red Lights</div>
                   
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/lights/red">Toggle</button>
                    
                </div>
            </div>

            <!-- Desk Lights Card -->
            <div>
                <div id="deskLightsCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Desk Lights</div>
                   
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/lights/desk">Toggle</button>
                    
                </div>
            </div>
        </div>
 
     <hr>  

<!-- Existing Roof Cards -->
<!-- ... -->

            <!-- Close Limit Switch Card -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
            <div>
                <div id="openLimitSwitchCard" class="card bg-white text-gray-800 shadow rounded mb-6">
               
                    <div class="card-body p-4">Open Limit Switch
                        <p class="card-text" id="openLimitStatus" data-topic="Observatory/roof/openlimit"></p>
                    </div>
                </div>
            </div>

            <!-- Open Limit Switch Card -->
            <div>
                <div id="closeLimitSwitchCard" class="card bg-white text-gray-800 shadow rounded mb-6">
                  
                    <div class="card-body p-4">Close Limit Switch
                        <p class="card-text" id="closeLimitStatus" data-topic="Observatory/roof/closelimit"></p>
                    </div>
                </div>
            </div>
        </div>   
<hr>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
            <!-- Open Roof Card -->
            <div>
                <div id="openRoofCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Open Roof</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/roof/open">Toggle</button>
                    
                </div>
            </div>

            <!-- Close Roof Card -->
            <div>
                <div id="closeRoofCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Close Roof</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/roof/close">Toggle</button>
                    
                </div>
            </div>
        </div>
   
        <hr>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
            <!-- Computer Card -->
            <div>
                <div id="computerCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">PC</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/Scope/Computer">Toggle</button>
                    
                </div>
            </div>

            <!-- Focuser Card -->
            <div>
                <div id="focuserCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Focus</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/Scope/Focus">Toggle</button>
                    
                </div>
            </div>

            <!-- Dew Heater Card -->
            <div>
                <div id="dewHeaterCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Dew</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/Scope/Dew">Toggle</button>
                   
                </div>
            </div>

            <!-- Scope Card -->
            <div>
                <div id="scopeCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Scope</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/Scope/Scope">Toggle</button>
                    
                </div>
            </div>
            <!-- Patio Sensor Card -->
            <div>
                <div id="patioCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Patio Sensor</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/Hue/PatioSensor">Toggle</button>
                    
                </div>
            </div>
            <!-- Veg Garden sensor -->
            <div>
                <div id="vegCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Veg Sensor</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="Observatory/Hue/ObservatorySensor">Toggle</button>
                    
                </div>
            </div>
            <!-- Workshop Lights sensor -->
            <div>
                <div id="workshopmotionCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Workshop Motion</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="workshop/sensors/motion">Toggle</button>
                    
                </div>
                
            </div>
        </div>
    </div>



<div class="container mx-auto my-4">
    <a href=http://skycam.smeird.com><img id="liveImage" src="https://skycam.smeird.com/indi-allsky/images/latest.jpg?cacheBuster=123456" alt="SkyCam Image" class="w-full h-auto"></a>
</div>

<script>
    function refreshImage() {
        const image = document.getElementById('liveImage');
        const timestamp = new Date().getTime();
        image.src = 'http://skycam.local/current/tmp/image.jpg?' + timestamp;

        // Clear the message initially
        document.getElementById('imageMessage').textContent = '';
        
        // Create a new image element for checking load/error
        const imgLoader = new Image();
        imgLoader.src = image.src;

        imgLoader.onload = function() {
            // Image loaded successfully, do nothing
        };

        imgLoader.onerror = function() {
            // Image failed to load, display message
            document.getElementById('imageMessage').textContent = 'Image failed to load. Please try refreshing the page.';
        };
    }

    // Refresh the image every 120 seconds
    setInterval(refreshImage, 120000);
</script>





    <!-- JavaScript Integration -->
<script type="text/javascript">
    const mqttClient = mqtt.connect('ws://homeassistant.smeird.com:1884', {
        username: 'smeird',
        password: '92987974' // Secure handling of credentials is essential
    });

    const toggleStates = {}; // Store the current state of each toggle

    mqttClient.on('connect', function () {
        const topics = [
            'Observatory/lights/white',
            'Observatory/lights/red',
            'Observatory/lights/desk',
            'Observatory/roof/open',
            'Observatory/roof/close',
            'Observatory/roof/power',
            'Observatory/Scope/Computer',
            'Observatory/Scope/Focus',
            'Observatory/Scope/Dew',
            'Observatory/Scope/Scope',
            'Observatory/Hue/ObservatorySensor',
            'Observatory/Hue/PatioSensor',
            'Observatory/roof/closelimit',
            'Observatory/roof/openlimit',
            'workshop/sensors/motion',
            'Observatory/clouds',
            'Observatory/rain',
            'Observatory/light',
            'Observatory/dewp',
            'skycam/stars',
            'Observatory/sqm'
        ];
        
        topics.forEach(topic => {
            mqttClient.subscribe(topic);
            toggleStates[topic] = '0'; // Initialize states to 'off'
        });
    });

    mqttClient.on('message', function (topic, message) {
        const messageStr = message.toString();
        toggleStates[topic] = messageStr; // Update the current state
        updateCard(topic, messageStr);
        updateValueDisplay(topic, messageStr); // New function to update text
    });

    document.querySelectorAll('.toggleButton').forEach(button => {
        button.addEventListener('click', function() {
            const topic = this.getAttribute('data-topic');
            const newState = toggleStates[topic] === '1' ? '0' : '1'; // Toggle the value
            mqttClient.publish(topic, newState,{ qos: 2, retain: true });
        });
    });


    const nonColourChangeTopics = [
        'Observatory/clouds',
        'Observatory/rain',
        'Observatory/light',
        'Observatory/dewp',
        'skycam/stars',
        'Observatory/sqm'
        // ... add other 6 topics here
    ];



    //function updateCard(topic, value) {
    //    const card = document.querySelector(`[data-topic='${topic}']`).closest('.card');
    //    card.className = 'card text-white text-center bg-' + (value === '1' ? 'success' : 'danger');
    //}

    function updateCard(topic, value) {
        const card = document.querySelector(`[data-topic='${topic}']`).closest('.card');

        // Check if the topic is in the nonColourChangeTopics array
        if (nonColourChangeTopics.includes(topic)) {
            // Keep the original colour for these topics
            card.classList.remove('bg-green-500', 'text-white');
            card.classList.add('bg-gray-100', 'text-black');
        } else {
            // For other topics, apply the colour change logic
            if (value === '1') {
                card.classList.remove('bg-gray-100', 'text-black');
                card.classList.add('bg-green-500', 'text-white');
            } else {
                card.classList.remove('bg-green-500', 'text-white');
                card.classList.add('bg-gray-100', 'text-black');
            }
        }
    }


    // New function to update card text based on topic
    //function updateValueDisplay(topic, value) {
    //    const valueDisplay = document.querySelector(`[data-topic='${topic}']`);
    //    if (valueDisplay) {
    //        valueDisplay.textContent = value;
    //    }
    //}
    function updateValueDisplay(topic, value) {
        // Check if the topic is in the nonColourChangeTopics array
        if (nonColourChangeTopics.includes(topic)) {
            const valueDisplay = document.querySelector(`[data-topic='${topic}']`);
            if (valueDisplay) {
                valueDisplay.textContent = value; // Update the text only for these topics
                const cardBody= valueDisplay.closest('.card-body');

        switch (topic) {
            case 'Observatory/clouds':
                updateCardBackground(cardBody, parseFloat(value) < -15, 'bg-green-500');
                break;
            case 'Observatory/rain':
                updateCardBackground(cardBody, parseFloat(value) > 4000, 'bg-green-500');
                break;
            case 'Observatory/light':
                updateCardBackground(cardBody, parseFloat(value) > 10000, 'bg-green-500');
                break;
            case 'Observatory/dewp':
                updateCardBackground(cardBody, parseFloat(value) < 5, 'bg-green-500');
                break;
            case 'Observatory/sqm':
                updateCardBackground(cardBody, parseFloat(value) > 18, 'bg-green-500');
                break;
            case 'skycam/stars':
                updateCardBackground(cardBody, parseFloat(value) > 20, 'bg-green-500');
                break;
        }

            }
        }
    } 

function updateCardBackground(cardBody, condition, className) {
    console.log("Updating card body background", { cardBody, condition, className });

    // Remove any previously set background classes
    cardBody.classList.remove('bg-gray-100', 'bg-green-500', 'bg-yellow-500', 'bg-blue-500', 'bg-gray-500');

    if (condition) {
        cardBody.classList.add(className); // Apply new background class
    } else {
        cardBody.classList.add('bg-gray-100'); // Default background class
    }
}
</script>

</body>

</html>


