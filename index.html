<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observatory Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>



  <!-- Bootstrap Navbar for Title Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Observatory Control Panel</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="http://10.0.179.242" target="_blank">AAGSolo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://data.smeird.com:3000/public-dashboards/9d4866d34e934549a20debd888358718?refresh=1m&from=now-24h&to=now&timezone=browser" target="_blank">Obs Graphs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://data.smeird.com:3000/public-dashboards/2ed28400ef714b6899a67ca635137a59" target="_blank">Weather</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://ob.smeird.com" target="_blank">Public obs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://www.smeird.com" target="_blank">Public Weather</a>
                    </li>
                    <li>
                    <a class="nav-link" href="https://clearoutside.com/forecast/51.81/-0.29" target="_blank">Night Forcast</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>





<div class="container   mt-5">

<!-- New Rows for Additional Cards -->
<div class="row">
    <!-- Example Card (Repeat for each new topic) -->
    <div class="col">
        <div id="cloudsCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Clouds</div>
            <div class="card-body">
                <p class="card-text" id="cloudsStatus" data-topic="Observatory/clouds">Loading...</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div id="rainCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Rain</div>
            <div class="card-body">
                <p class="card-text" id="rainStatus" data-topic="Observatory/rain">Loading...</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div id="lightCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Light</div>
            <div class="card-body">
                <p class="card-text" id="lightStatus" data-topic="Observatory/light">Loading...</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div id="dewCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Dew</div>
            <div class="card-body">
                <p class="card-text" id="dewStatus" data-topic="Observatory/dewp">Loading...</p>
            </div>
        </div>
    </div>
  <div class="col">
        <div id="sqmCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">SQM</div>
            <div class="card-body">
                <p class="card-text" id="sqmStatus" data-topic="Observatory/sqm">Loading...</p>
            </div>
        </div>
    </div>

 <div class="col">
        <div id="starsCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Stars</div>
            <div class="card-body">
                <p class="card-text" id="starsStatus" data-topic="skycam/stars">Loading...</p>
            </div>
        </div>
    </div>








    <!-- Repeat for other 7 cards in the row -->
</div>
<!-- Repeat for the second row with different topics -->

<hr>
        
        <div class="row">
              <!-- White Lights Card -->
            <div class="col">
                <div id="whiteLightsCard" class="card text-white  bg-secondary mb-2">
                    <div class="card-header">12V Power</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/roof/power">Toggle</button>
                    
                </div>
            </div>          
                
            <!-- White Lights Card -->
            <div class="col">
                <div id="whiteLightsCard" class="card text-white bg-secondary mb-2">
                    
                    <div class="card-header">White Lights</div>
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/lights/white">Toggle</button>
                    
                </div>
            </div>

            <!-- Red Lights Card -->
            <div class="col">
                <div id="redLightsCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Red Lights</div>
                   
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/lights/red">Toggle</button>
                    
                </div>
            </div>

            <!-- Desk Lights Card -->
            <div class="col">
                <div id="deskLightsCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Desk Lights</div>
                   
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/lights/desk">Toggle</button>
                    
                </div>
            </div>
        </div>
 
     <hr>  

<!-- Existing Roof Cards -->
<!-- ... -->

            <!-- Close Limit Switch Card -->
            <div class="row">
            <div class="col">
                <div id="openLimitSwitchCard" class="card text-white bg-secondary mb-6">
               
                    <div class="card-body">Open Limit Switch
                        <p class="card-text" id="openLimitStatus" data-topic="Observatory/roof/openlimit"></p>
                    </div>
                </div>
            </div>

            <!-- Open Limit Switch Card -->
            <div class="col">
                <div id="closeLimitSwitchCard" class="card text-white bg-secondary mb-6">
                  
                    <div class="card-body">Close Limit Switch
                        <p class="card-text" id="closeLimitStatus" data-topic="Observatory/roof/closelimit"></p>
                    </div>
                </div>
            </div>
        </div>   
<hr>

        <div class="row">
            <!-- Open Roof Card -->
            <div class="col">
                <div id="openRoofCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Open Roof</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/roof/open">Toggle</button>
                    
                </div>
            </div>

            <!-- Close Roof Card -->
            <div class="col">
                <div id="closeRoofCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Close Roof</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/roof/close">Toggle</button>
                    
                </div>
            </div>
        </div>
   
        <hr>
        <div class="row">
            <!-- Computer Card -->
            <div class="col">
                <div id="computerCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">PC</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/Scope/Computer">Toggle</button>
                    
                </div>
            </div>

            <!-- Focuser Card -->
            <div class="col">
                <div id="focuserCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Focus</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/Scope/Focus">Toggle</button>
                    
                </div>
            </div>

            <!-- Dew Heater Card -->
            <div class="col">
                <div id="dewHeaterCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Dew</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/Scope/Dew">Toggle</button>
                   
                </div>
            </div>

            <!-- Scope Card -->
            <div class="col">
                <div id="scopeCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Scope</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/Scope/Scope">Toggle</button>
                    
                </div>
            </div>
            <!-- Patio Sensor Card -->
            <div class="col">
                <div id="patioCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Patio Sensor</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/Hue/PatioSensor">Toggle</button>
                    
                </div>
            </div>
            <!-- Veg Garden sensor -->
            <div class="col">
                <div id="vegCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Veg Sensor</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="Observatory/Hue/ObservatorySensor">Toggle</button>
                    
                </div>
            </div>
            <!-- Workshop Lights sensor -->
            <div class="col">
                <div id="workshopmotionCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Workshop Motion</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="workshop/sensors/motion">Toggle</button>
                    
                </div>
                
            </div>
        </div>
    </div>



<div class="container my-4">
    <a href=http://skycam.smeird.com><img id="liveImage" src="https://skycam.smeird.com/indi-allsky/images/latest.jpg?cacheBuster=123456" alt="SkyCam Image" class="img-fluid"></a>
</div>

<script>
    function refreshImage() {
        const image = document.getElementById('liveImage');
        const timestamp = new Date().getTime();
        image.src = 'http://skycam.local/current/tmp/image.jpg?' + timestamp;

        // Clear the message initially
        document.getElementById('imageMessage').textContent = '';
        
        // Create a new image element for checking load/error
        const imgLoader = new Image();
        imgLoader.src = image.src;

        imgLoader.onload = function() {
            // Image loaded successfully, do nothing
        };

        imgLoader.onerror = function() {
            // Image failed to load, display message
            document.getElementById('imageMessage').textContent = 'Image failed to load. Please try refreshing the page.';
        };
    }

    // Refresh the image every 120 seconds
    setInterval(refreshImage, 120000);
</script>





    <!-- JavaScript Integration -->
<script type="text/javascript">
    const mqttClient = mqtt.connect('ws://homeassistant.smeird.com:1884', {
        username: 'smeird',
        password: '92987974' // Secure handling of credentials is essential
    });

    const toggleStates = {}; // Store the current state of each toggle

    mqttClient.on('connect', function () {
        const topics = [
            'Observatory/lights/white',
            'Observatory/lights/red',
            'Observatory/lights/desk',
            'Observatory/roof/open',
            'Observatory/roof/close',
            'Observatory/roof/power',
            'Observatory/Scope/Computer',
            'Observatory/Scope/Focus',
            'Observatory/Scope/Dew',
            'Observatory/Scope/Scope',
            'Observatory/Hue/ObservatorySensor',
            'Observatory/Hue/PatioSensor',
            'Observatory/roof/closelimit',
            'Observatory/roof/openlimit',
            'workshop/sensors/motion',
            'Observatory/clouds',
            'Observatory/rain',
            'Observatory/light',
            'Observatory/dewp',
            'skycam/stars',
            'Observatory/sqm'
        ];
        
        topics.forEach(topic => {
            mqttClient.subscribe(topic);
            toggleStates[topic] = '0'; // Initialize states to 'off'
        });
    });

    mqttClient.on('message', function (topic, message) {
        const messageStr = message.toString();
        toggleStates[topic] = messageStr; // Update the current state
        updateCard(topic, messageStr);
        updateValueDisplay(topic, messageStr); // New function to update text
    });

    document.querySelectorAll('.toggleButton').forEach(button => {
        button.addEventListener('click', function() {
            const topic = this.getAttribute('data-topic');
            const newState = toggleStates[topic] === '1' ? '0' : '1'; // Toggle the value
            mqttClient.publish(topic, newState,{ qos: 2, retain: true });
        });
    });


    const nonColourChangeTopics = [
        'Observatory/clouds',
        'Observatory/rain',
        'Observatory/light',
        'Observatory/dewp',
        'skycam/stars',
        'Observatory/sqm'
        // ... add other 6 topics here
    ];



    //function updateCard(topic, value) {
    //    const card = document.querySelector(`[data-topic='${topic}']`).closest('.card');
    //    card.className = 'card text-white text-center bg-' + (value === '1' ? 'success' : 'danger');
    //}

    function updateCard(topic, value) {
        const card = document.querySelector(`[data-topic='${topic}']`).closest('.card');

        // Check if the topic is in the nonColourChangeTopics array
        if (nonColourChangeTopics.includes(topic)) {
            // Keep the original colour for these topics
            card.className = 'card text-center text-black bg-light';
        } else {
            // For other topics, apply the colour change logic
            card.className = 'card text-center text-auto bg-' + (value === '1' ? 'success' : 'light');
        }
    }


    // New function to update card text based on topic
    //function updateValueDisplay(topic, value) {
    //    const valueDisplay = document.querySelector(`[data-topic='${topic}']`);
    //    if (valueDisplay) {
    //        valueDisplay.textContent = value;
    //    }
    //}
    function updateValueDisplay(topic, value) {
        // Check if the topic is in the nonColourChangeTopics array
        if (nonColourChangeTopics.includes(topic)) {
            const valueDisplay = document.querySelector(`[data-topic='${topic}']`);
            if (valueDisplay) {
                valueDisplay.textContent = value; // Update the text only for these topics
                const cardBody= valueDisplay.closest('.card-body');

        switch (topic) {
            case 'Observatory/clouds':
                updateCardBackground(cardBody, parseFloat(value) < -15, 'bg-success'); // Blue for < -15
                break;
            case 'Observatory/rain':
                updateCardBackground(cardBody, parseFloat(value) > 4000, 'bg-success'); // Blue for < 4000
                break;
            case 'Observatory/light':
                updateCardBackground(cardBody, parseFloat(value) > 10000, 'bg-success'); // Yellow for > 10000
                break;
            case 'Observatory/dewp':
                updateCardBackground(cardBody, parseFloat(value) < 5, 'bg-success'); // Yellow for > 5
                break;
            case 'Observatory/sqm':
                updateCardBackground(cardBody, parseFloat(value) > 18, 'bg-success'); // Yellow for > 18
                break;
            case 'skycam/stars':
                updateCardBackground(cardBody, parseFloat(value) > 20, 'bg-success'); // Yellow for > 1
                break;
		
		default:
                // Reset to default or other specified color
                card.classList.remove('bg-info', 'bg-warning');
                card.classList.add('bg-secondary');
        }

            }
        }
    } 

function updateCardBackground(cardBody, condition, className) {
    console.log("Updating card body background", { cardBody, condition, className });

    // Remove any previously set background classes
    cardBody.classList.remove('bg-light', 'bg-info', 'bg-warning', 'bg-secondary');
    
    if (condition) {
        cardBody.classList.add(className); // Apply new background class
    } else {
        cardBody.classList.add('bg-light'); // Default background class
    }
}
</script>

</body>

</html>


