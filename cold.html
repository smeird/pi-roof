<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coldframe Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>



  <!-- Bootstrap Navbar for Title Bar -->
    <nav class="bg-blue-800">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a class="text-white font-bold" href="#">Coldframe Control Panel</a>
                <ul class="flex space-x-4">
                    <li><a class="text-gray-200 hover:text-white" href="http://admin.smeird.com:3000/public-dashboards/fd7e1047df104407b8cd11f0876b6106?orgId=1" target="_blank">Weather</a></li>
                    <li><a class="text-gray-200 hover:text-white" href="http://garden.smeird.com" target="_blank">Garden System</a></li>
                    <li><a class="text-gray-200 hover:text-white" href="http://www.smeird.com" target="_blank">Public Weather</a></li>
                    <li><a class="text-gray-200 hover:text-white" href="recipies.html" target="_blank">Recipies</a></li>
                </ul>
            </div>
        </div>
    </nav>








<div class="container mx-auto mt-5">

<!-- New Rows for Additional Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    <!-- Example Card (Repeat for each new topic) -->
    <div>
        <div id="TempCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Temperature</div>
            <div class="card-body p-4">
                <p class="card-text" id="TempStatus" data-topic="garden/coldframe/temperature/current">Loading...</p>
            </div>
        </div>
    </div>
     <div>
        <div id="TempTargetCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Set Temp</div>
            <div class="card-body p-4">
                <p class="card-text" id="TempTargetStatus" data-topic="garden/coldframe/temperature/target">Loading...</p>
            </div>
        </div>
    </div>   
    <div>
        <div id="HumCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Humditiy</div>
            <div class="card-body p-4">
                <p class="card-text" id="HumStatus" data-topic="garden/coldframe/humidity/current">Loading...</p>
            </div>
        </div>
    </div>
        <div>
        <div id="RecipieCard" class="card bg-white text-gray-800 shadow rounded mb-2">
            <div class="card-header px-4 py-2 font-semibold border-b">Recipe</div>
            <div class="card-body p-4">
                <p class="card-text" id="RecStatus" data-topic="garden/coldframe/recipe/set">Loading...</p>
            </div>
        </div>
    </div>
    </div>
    <BR>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <div>
            <div id="windowCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                <div class="card-header px-4 py-2 font-semibold border-b">Window</div>
                <div class="card-body p-4">
                    <p class="card-text" id="windowStatus" data-topic="garden/coldframe/window/status">Loading...</p>
                </div>
            </div>
        </div>
        <div>
            <div id="heatCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                <div class="card-header px-4 py-2 font-semibold border-b">Heater</div>
                <div class="card-body p-4">
                    <p class="card-text" id="heatStatus" data-topic="garden/coldframe/heater/status">Loading...</p>
                </div>
            </div>
        </div>
    <div>
            <div id="WaterCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                <div class="card-header px-4 py-2 font-semibold border-b">Water Flow</div>
                <div class="card-body p-4">
                    <p class="card-text" id="waterStatus" data-topic="garden/gms/flow">Loading...</p>
                </div>
            </div>
        </div>
        <div>
            <div id="WaterTargetCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                <div class="card-header px-4 py-2 font-semibold border-b">Water Target</div>
                <div class="card-body p-4">
                    <p class="card-text" id="waterTargetStatus" data-topic="garden/coldframe/watering/control">Loading...</p>
                </div>
            </div>
        </div>
   </div>

<!-- Repeat for the second row with different topics -->

<hr>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              <!-- White Lights Card -->
            <div>
                <div id="waterCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Water</div>
                    
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="garden/coldframe/watering/enabled">Toggle</button>
                    
                </div>
            </div>          
                
            <!-- White Lights Card -->
            <div>
                <div id="windowopenCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    
                    <div class="card-header px-4 py-2 font-semibold border-b">Window Open </div>
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="garden/coldframe/window/open">Toggle</button>
                    
                </div>
            </div>

            <!-- Red Lights Card -->
            <div>
                <div id="windowcloseCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Window Close</div>
                   
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="garden/coldframe/window/close">Toggle</button>
                    
                </div>
            </div>

            <!-- Desk Lights Card -->
            <div>
                <div id="deskLightsCard" class="card bg-white text-gray-800 shadow rounded mb-2">
                    <div class="card-header px-4 py-2 font-semibold border-b">Heater</div>
                   
                        <button class="toggleButton px-2 py-1 bg-gray-500 text-white rounded" data-topic="garden/coldframe/heater/control">Toggle</button>
                    
                </div>
            </div>
        </div>
 
     <hr>  

<!-- Existing Roof Cards -->
<!-- ... -->

   
     </div>





    <!-- JavaScript Integration -->
<script type="text/javascript">
    const mqttClient = mqtt.connect('wss://mqtt.smeird.com:8083', {
        username: 'gardenman',
        password: 'GardenPasswd' // Secure handling of credentials is essential
    });

    const toggleStates = {}; // Store the current state of each toggle

    mqttClient.on('connect', function () {
        const topics = [
            'garden/coldframe/window/open',
            'garden/coldframe/window/close',
            'garden/coldframe/heater/control',
            'garden/coldframe/recipe/set',
            'garden/coldframe/watering/enabled',
            'garden/coldframe/window/open',
            'garden/coldframe/window/close',
            'garden/coldframe/temperature/current',
            'garden/coldframe/humidity/current',
            'garden/coldframe/window/status',
            'garden/coldframe/heater/status',
            'garden/coldframe/temperature/target',
            'garden/gms/flow',
            'garden/coldframe/watering/control'
        ];
        
        topics.forEach(topic => {
            mqttClient.subscribe(topic);
            toggleStates[topic] = 'false'; // Initialize states to 'off'
        });
    });

    mqttClient.on('message', function (topic, message) {
        const messageStr = message.toString();
        toggleStates[topic] = messageStr; // Update the current state
        updateCard(topic, messageStr);
        updateValueDisplay(topic, messageStr); // New function to update text
    });

    document.querySelectorAll('.toggleButton').forEach(button => {
        button.addEventListener('click', function() {
            const topic = this.getAttribute('data-topic');
            const newState = toggleStates[topic] === 'true' ? 'false' : 'true'; // Toggle the value
            mqttClient.publish(topic, newState,{ qos: 2, retain: true });
        });
    });


    const nonColourChangeTopics = [
        'garden/coldframe/temperature/current',
        'garden/coldframe/humidity/current',
        'garden/coldframe/watering/control',
        'garden/coldframe/window/status',
        'garden/coldframe/heater/status',
        'garden/coldframe/temperature/target',
        'garden/coldframe/recipe/set',
        'garden/gms/flow'
        // ... add other 6 topics here
    ];



    //function updateCard(topic, value) {
    //    const card = document.querySelector(`[data-topic='${topic}']`).closest('.card');
    //    card.className = 'card text-white text-center bg-' + (value === '1' ? 'success' : 'danger');
    //}

    function updateCard(topic, value) {
        const card = document.querySelector(`[data-topic='${topic}']`).closest('.card');

        // Check if the topic is in the nonColourChangeTopics array
        if (nonColourChangeTopics.includes(topic)) {
            // Keep the original colour for these topics
            card.classList.remove('bg-green-500', 'text-white');
            card.classList.add('bg-gray-100', 'text-black');
        } else {
            // For other topics, apply the colour change logic
            if (value === 'true') {
                card.classList.remove('bg-gray-100', 'text-black');
                card.classList.add('bg-green-500', 'text-white');
            } else {
                card.classList.remove('bg-green-500', 'text-white');
                card.classList.add('bg-gray-100', 'text-black');
            }
        }
    }


    // New function to update card text based on topic
    //function updateValueDisplay(topic, value) {
    //    const valueDisplay = document.querySelector(`[data-topic='${topic}']`);
    //    if (valueDisplay) {
    //        valueDisplay.textContent = value;
    //    }
    //}
    function updateValueDisplay(topic, value) {
        // Check if the topic is in the nonColourChangeTopics array
        if (nonColourChangeTopics.includes(topic)) {
            const valueDisplay = document.querySelector(`[data-topic='${topic}']`);
            if (valueDisplay) {
                valueDisplay.textContent = value; // Update the text only for these topics
                const cardBody= valueDisplay.closest('.card-body');

        switch (topic) {
            case 'garden/coldframe/temperature/current':
                updateCardBackground(cardBody, parseFloat(value) > 5, 'bg-green-500');
                break;
            case 'garden/coldframe/temperature/target':
                updateCardBackground(cardBody, parseFloat(value) > 5, 'bg-green-500');
                break;
            case 'garden/coldframe/humidity/current':
                updateCardBackground(cardBody, parseFloat(value) > 20, 'bg-green-500');
                break;
            case 'garden/coldframe/window/status':
                updateCardBackground(cardBody, value === "Closed", 'bg-green-500');
                break;
            case 'garden/coldframe/heater/status':
                updateCardBackground(cardBody, value === "On", 'bg-green-500');
                break;
            case 'garden/gms/flow':
                updateCardBackground(cardBody, parseFloat(value) > 0, 'bg-green-500');
                break;
            case 'garden/coldframe/watering/control':
                updateCardBackground(cardBody, parseFloat(value) > 0, 'bg-green-500');
                break;
            default:
                break;
        }

            }
        }
    } 

function updateCardBackground(cardBody, condition, className) {
    console.log("Updating card body background", { cardBody, condition, className });

    // Remove any previously set background classes
    cardBody.classList.remove('bg-gray-100', 'bg-green-500', 'bg-yellow-500', 'bg-blue-500', 'bg-gray-500');

    if (condition) {
        cardBody.classList.add(className); // Apply new background class
    } else {
        cardBody.classList.add('bg-gray-100'); // Default background class
    }
}
</script>

<!-- Include Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Include date-fns library (required by the date adapter) -->
<script src="https://cdn.jsdelivr.net/npm/date-fns@3.3.1/index.min.js"></script>

<!-- Include  -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<div class="container mx-auto mt-5">
<div class="card-body p-4">
<canvas id="temperatureChart"></canvas>
</div>
</div>


<script>
  // Function to fetch temperature data from your API endpoint
  function fetchTemperatureData() {
    // Calculate the start and end dates for the last 24 hours
    let endDate = new Date();
    let startDate = new Date(endDate.getTime() - 24*60*60*1000); // Subtract 24 hours

    // Format dates to YYYY-MM-DD format
    let formattedStartDate = startDate.toISOString().split('T')[0];
    let formattedEndDate = endDate.toISOString().split('T')[0];

    // Construct the API URL with dynamic dates
    let apiUrl = `http://coldframe.smeird.com:1880/api/graph?startDate=${formattedStartDate}&endDate=${formattedEndDate}&fields=Temperature_C`;

    // Fetch data from the API
    fetch(apiUrl)
      .then((response) => response.json())
      .then((data) => {
        // Extract the relevant data for the chart
        const timestamps = data.map((entry) => entry.SummaryTimestamp);
        const temperatures = data.map((entry) => entry.Temperature_C);

        // Create a Chart.js data object
        const temperatureData = {
          labels: timestamps,
          datasets: [
            {
              label: "Temperature (°C)",
              data: temperatures,
              fill: false,
              borderColor: "rgb(75, 192, 192)",
              tension: 0.2,
            },
          ],
        };

        // Get the canvas element
        const ctx = document.getElementById("temperatureChart").getContext("2d");

        // Create the temperature chart
        new Chart(ctx, {
          type: "line",
          data: temperatureData,
          options: {
            responsive: true,
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "hour", // Adjust the time unit as needed
                  displayFormats: {
                    hour: "HH:mm", // Display format for timestamps
                  },
                },
                title: {
                  display: true,
                  text: "Time",
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Temperature (°C)",
                },
              },
            },
          },
        });
      })
      .catch((error) => {
        console.error("Error fetching temperature data:", error);
      });
  }

  // Call the fetchTemperatureData function to load and display the graph
  fetchTemperatureData();
</script>






</body>

</html>