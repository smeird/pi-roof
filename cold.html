<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coldframe Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>



  <!-- Bootstrap Navbar for Title Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Coldframe Control Panel</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="http://admin.smeird.com:3000/public-dashboards/fd7e1047df104407b8cd11f0876b6106?orgId=1" target="_blank">Weather</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://garden.smeird.com" target="_blank">Garden System</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://www.smeird.com" target="_blank">Public Weather</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="recipies.html" target="_blank">Recipies</a>
                    </li>
                  </ul>
            </div>
        </div>
    </nav>








<div class="container   mt-5">

<!-- New Rows for Additional Cards -->
<div class="row">
    <!-- Example Card (Repeat for each new topic) -->
    <div class="col">
        <div id="TempCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Temperature</div>
            <div class="card-body">
                <p class="card-text" id="TempStatus" data-topic="garden/coldframe/temperature/current">Loading...</p>
            </div>
        </div>
    </div>
     <div class="col">
        <div id="TempTargetCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Set Temp</div>
            <div class="card-body">
                <p class="card-text" id="TempTargetStatus" data-topic="garden/coldframe/temperature/target">Loading...</p>
            </div>
        </div>
    </div>   
    <div class="col">
        <div id="HumCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Humditiy</div>
            <div class="card-body">
                <p class="card-text" id="HumStatus" data-topic="garden/coldframe/humidity/current">Loading...</p>
            </div>
        </div>
    </div>
        <div class="col">
        <div id="RecipieCard" class="card text-white text-bg-light mb-2">
            <div class="card-header">Recipe</div>
            <div class="card-body">
                <p class="card-text" id="RecStatus" data-topic="garden/coldframe/recipe/set">Loading...</p>
            </div>
        </div>
    </div>
    </div>
    <BR>
    <div class="row">
        <div class="col">
            <div id="windowCard" class="card text-white text-bg-light mb-2">
                <div class="card-header">Window</div>
                <div class="card-body">
                    <p class="card-text" id="windowStatus" data-topic="garden/coldframe/window/status">Loading...</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div id="heatCard" class="card text-white text-bg-light mb-2">
                <div class="card-header">Heater</div>
                <div class="card-body">
                    <p class="card-text" id="heatStatus" data-topic="garden/coldframe/heater/status">Loading...</p>
                </div>
            </div>
        </div>
    <div class="col">
            <div id="WaterCard" class="card text-white text-bg-light mb-2">
                <div class="card-header">Water Flow</div>
                <div class="card-body">
                    <p class="card-text" id="waterStatus" data-topic="garden/gms/flow">Loading...</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div id="WaterTargetCard" class="card text-white text-bg-light mb-2">
                <div class="card-header">Water Target</div>
                <div class="card-body">
                    <p class="card-text" id="waterTargetStatus" data-topic="garden/coldframe/watering/control">Loading...</p>
                </div>
            </div>
        </div>
   </div>

<!-- Repeat for the second row with different topics -->

<hr>
        
        <div class="row">
              <!-- White Lights Card -->
            <div class="col">
                <div id="waterCard" class="card text-white  bg-secondary mb-2">
                    <div class="card-header">Water</div>
                    
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="garden/coldframe/watering/enabled">Toggle</button>
                    
                </div>
            </div>          
                
            <!-- White Lights Card -->
            <div class="col">
                <div id="windowopenCard" class="card text-white bg-secondary mb-2">
                    
                    <div class="card-header">Window Open </div>
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="garden/coldframe/window/open">Toggle</button>
                    
                </div>
            </div>

            <!-- Red Lights Card -->
            <div class="col">
                <div id="windowcloseCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Window Close</div>
                   
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="garden/coldframe/window/close">Toggle</button>
                    
                </div>
            </div>

            <!-- Desk Lights Card -->
            <div class="col">
                <div id="deskLightsCard" class="card text-white bg-secondary mb-2">
                    <div class="card-header">Heater</div>
                   
                        <button class="toggleButton btn btn-sm btn-secondary" data-topic="garden/coldframe/heater/control">Toggle</button>
                    
                </div>
            </div>
        </div>
 
     <hr>  

<!-- Existing Roof Cards -->
<!-- ... -->

   
     </div>





    <!-- JavaScript Integration -->
<script type="text/javascript">
    const mqttClient = mqtt.connect('wss://mqtt.smeird.com:8083', {
        username: 'gardenman',
        password: 'GardenPasswd' // Secure handling of credentials is essential
    });

    const toggleStates = {}; // Store the current state of each toggle

    mqttClient.on('connect', function () {
        const topics = [
            'garden/coldframe/window/open',
            'garden/coldframe/window/close',
            'garden/coldframe/heater/control',
            'garden/coldframe/recipe/set',
            'garden/coldframe/watering/enabled',
            'garden/coldframe/window/open',
            'garden/coldframe/window/close',
            'garden/coldframe/temperature/current',
            'garden/coldframe/humidity/current',
            'garden/coldframe/window/status',
            'garden/coldframe/heater/status',
            'garden/coldframe/temperature/target',
            'garden/gms/flow',
            'garden/coldframe/watering/control'
        ];
        
        topics.forEach(topic => {
            mqttClient.subscribe(topic);
            toggleStates[topic] = 'false'; // Initialize states to 'off'
        });
    });

    mqttClient.on('message', function (topic, message) {
        const messageStr = message.toString();
        toggleStates[topic] = messageStr; // Update the current state
        updateCard(topic, messageStr);
        updateValueDisplay(topic, messageStr); // New function to update text
    });

    document.querySelectorAll('.toggleButton').forEach(button => {
        button.addEventListener('click', function() {
            const topic = this.getAttribute('data-topic');
            const newState = toggleStates[topic] === 'true' ? 'false' : 'true'; // Toggle the value
            mqttClient.publish(topic, newState,{ qos: 2, retain: true });
        });
    });


    const nonColourChangeTopics = [
        'garden/coldframe/temperature/current',
        'garden/coldframe/humidity/current',
        'garden/coldframe/watering/control',
        'garden/coldframe/window/status',
        'garden/coldframe/heater/status',
        'garden/coldframe/temperature/target',
        'garden/coldframe/recipe/set',
        'garden/gms/flow'
        // ... add other 6 topics here
    ];



    //function updateCard(topic, value) {
    //    const card = document.querySelector(`[data-topic='${topic}']`).closest('.card');
    //    card.className = 'card text-white text-center bg-' + (value === '1' ? 'success' : 'danger');
    //}

    function updateCard(topic, value) {
        const card = document.querySelector(`[data-topic='${topic}']`).closest('.card');

        // Check if the topic is in the nonColourChangeTopics array
        if (nonColourChangeTopics.includes(topic)) {
            // Keep the original colour for these topics
            card.className = 'card text-center text-black bg-light';
        } else {
            // For other topics, apply the colour change logic
            card.className = 'card text-center text-auto bg-' + (value === 'true' ? 'success' : 'light');
        }
    }


    // New function to update card text based on topic
    //function updateValueDisplay(topic, value) {
    //    const valueDisplay = document.querySelector(`[data-topic='${topic}']`);
    //    if (valueDisplay) {
    //        valueDisplay.textContent = value;
    //    }
    //}
    function updateValueDisplay(topic, value) {
        // Check if the topic is in the nonColourChangeTopics array
        if (nonColourChangeTopics.includes(topic)) {
            const valueDisplay = document.querySelector(`[data-topic='${topic}']`);
            if (valueDisplay) {
                valueDisplay.textContent = value; // Update the text only for these topics
                const cardBody= valueDisplay.closest('.card-body');

        switch (topic) {
            case 'garden/coldframe/temperature/current':
                updateCardBackground(cardBody, parseFloat(value) > 5, 'bg-success'); // Blue for < -15
                break;           
            case 'garden/coldframe/temperature/target':
                updateCardBackground(cardBody, parseFloat(value) > 5, 'bg-success'); // Blue for < -15
                break;    
            case 'garden/coldframe/humidity/current':
                updateCardBackground(cardBody, parseFloat(value) > 20, 'bg-success'); // Blue for < 4000
                break;
            case 'garden/coldframe/window/status':
                updateCardBackground(cardBody, value === "Closed", 'bg-success'); // Yellow for > 5
                break; 
            case 'garden/coldframe/heater/status':
                updateCardBackground(cardBody, value === "On", 'bg-success'); // Yellow for > 5
                break;
            case 'garden/gms/flow':
                updateCardBackground(cardBody, parseFloat(value) > 0, 'bg-success'); // Yellow for > 18
                break;
            case 'garden/coldframe/watering/control':
                updateCardBackground(cardBody, parseFloat(value) > 0, 'bg-success'); // Yellow for > 18
                break;
            default:
                // Reset to default or other specified color
                //card.classList.remove('bg-info', 'bg-warning');
                //card.classList.add('bg-secondary');
                    }

            }
        }
    } 

function updateCardBackground(cardBody, condition, className) {
    console.log("Updating card body background", { cardBody, condition, className });

    // Remove any previously set background classes
    cardBody.classList.remove('bg-light', 'bg-info', 'bg-warning', 'bg-secondary');
    
    if (condition) {
        cardBody.classList.add(className); // Apply new background class
    } else {
        cardBody.classList.add('bg-light'); // Default background class
    }
}
</script>

<!-- Include Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Include date-fns library (required by the date adapter) -->
<script src="https://cdn.jsdelivr.net/npm/date-fns@3.3.1/index.min.js"></script>

<!-- Include  -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<div class="container mt-5">
<div class="card-body">
<canvas id="temperatureChart"></canvas>
</div>
</div>


<script>
  // Function to fetch temperature data from your API endpoint
  function fetchTemperatureData() {
    // Calculate the start and end dates for the last 24 hours
    let endDate = new Date();
    let startDate = new Date(endDate.getTime() - 24*60*60*1000); // Subtract 24 hours

    // Format dates to YYYY-MM-DD format
    let formattedStartDate = startDate.toISOString().split('T')[0];
    let formattedEndDate = endDate.toISOString().split('T')[0];

    // Construct the API URL with dynamic dates
    let apiUrl = `http://coldframe.smeird.com:1880/api/graph?startDate=${formattedStartDate}&endDate=${formattedEndDate}&fields=Temperature_C`;

    // Fetch data from the API
    fetch(apiUrl)
      .then((response) => response.json())
      .then((data) => {
        // Extract the relevant data for the chart
        const timestamps = data.map((entry) => entry.SummaryTimestamp);
        const temperatures = data.map((entry) => entry.Temperature_C);

        // Create a Chart.js data object
        const temperatureData = {
          labels: timestamps,
          datasets: [
            {
              label: "Temperature (°C)",
              data: temperatures,
              fill: false,
              borderColor: "rgb(75, 192, 192)",
              tension: 0.2,
            },
          ],
        };

        // Get the canvas element
        const ctx = document.getElementById("temperatureChart").getContext("2d");

        // Create the temperature chart
        new Chart(ctx, {
          type: "line",
          data: temperatureData,
          options: {
            responsive: true,
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "hour", // Adjust the time unit as needed
                  displayFormats: {
                    hour: "HH:mm", // Display format for timestamps
                  },
                },
                title: {
                  display: true,
                  text: "Time",
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Temperature (°C)",
                },
              },
            },
          },
        });
      })
      .catch((error) => {
        console.error("Error fetching temperature data:", error);
      });
  }

  // Call the fetchTemperatureData function to load and display the graph
  fetchTemperatureData();
</script>






</body>

</html>